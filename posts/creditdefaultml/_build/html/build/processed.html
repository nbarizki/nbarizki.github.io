
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Implementing Machine Learning Model to Predict and Select Loan &#8212; Implementing Machine Learning Model for Loan Classification and Selection</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Implementing Machine Learning Model for Loan Classification and Selection</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../README.html">
                    Implementing Machine Learning Model to Predict and Select Loan
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../1_Dataset_indentification_and_preprocessing.html">
   LendingClub Dataset - A collection of Peer-to-Peer Individual Loan History
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../2_Data_exploration.html">
   Exploratory Analysis of LendingClub Loan Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../3_Model_development.html">
   Implementing Machine Learning Model to Predict and Select Loan
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/nbarizki/creditdefaultml/main?urlpath=tree/build/processed.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/nbarizki/creditdefaultml"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/nbarizki/creditdefaultml/issues/new?title=Issue%20on%20page%20%2Fbuild/processed.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/build/processed.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#case-example-lendingclub-loan-data">
   <em>
    Case Example: LendingClub Loan Data
   </em>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#contents">
     Contents
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   1. Introduction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-to-do">
     <strong>
      What to Do?
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#related-notebooks">
     <strong>
      Related Notebooks
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-evaluation-of-model">
     <strong>
      Performance Evaluation of Model
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dataset-preparation">
   2. Dataset Preparation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-dataset">
     <strong>
      The Dataset
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preparing-the-dataset">
     <strong>
      Preparing the Dataset
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#features-preparation">
   3. Features Preparation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#categorical-features">
     <strong>
      Categorical Features
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#numerical-features">
     <strong>
      Numerical Features
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#combining-feature-preprocess">
     <strong>
      Combining Feature Preprocess
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-selection">
   4. Model Selection
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#feature-engineering">
   5. Feature Engineering
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#feature-transformation">
     <strong>
      Feature Transformation
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extracting-post-originated-features">
     <strong>
      Extracting Post-Originated Features
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#combining-into-pipeline">
     <strong>
      Combining into Pipeline
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hyperparameter-optimization">
   6. Hyperparameter Optimization
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initial-hyperparameter-optimization">
     <strong>
      Initial Hyperparameter Optimization
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analyzing-optimization-results">
     <strong>
      Analyzing Optimization Results
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#zooming-the-hyperparameters">
     <strong>
      Zooming the Hyperparameters
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-implementation-selecting-profitable-loan">
   7. Model Implementation: Selecting Profitable Loan
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preparation">
     7.1. Preparation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#strategy">
       <strong>
        Strategy
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#preparing-the-data">
       <strong>
        Preparing the Data
       </strong>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#develop-the-selectors-and-optimization-process">
     7.2. Develop the
     <code class="docutils literal notranslate">
      <span class="pre">
       Selectors
      </span>
     </code>
     and Optimization Process
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#knapsack-problem-and-solving-using-pyomo">
       <strong>
        Knapsack Problem and Solving using
        <em>
         Pyomo
        </em>
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#selector-a">
       <strong>
        Selector A
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#selector-b">
       <strong>
        Selector B
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#selector-c">
       <strong>
        Selector C
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#selector-d">
       <strong>
        Selector D
       </strong>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#comparation-of-selector-performance">
     7.3. Comparation of
     <code class="docutils literal notranslate">
      <span class="pre">
       Selector
      </span>
     </code>
     Performance
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#final-words">
   8. Final Words
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Implementing Machine Learning Model to Predict and Select Loan</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#case-example-lendingclub-loan-data">
   <em>
    Case Example: LendingClub Loan Data
   </em>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#contents">
     Contents
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   1. Introduction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-to-do">
     <strong>
      What to Do?
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#related-notebooks">
     <strong>
      Related Notebooks
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-evaluation-of-model">
     <strong>
      Performance Evaluation of Model
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dataset-preparation">
   2. Dataset Preparation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-dataset">
     <strong>
      The Dataset
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preparing-the-dataset">
     <strong>
      Preparing the Dataset
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#features-preparation">
   3. Features Preparation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#categorical-features">
     <strong>
      Categorical Features
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#numerical-features">
     <strong>
      Numerical Features
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#combining-feature-preprocess">
     <strong>
      Combining Feature Preprocess
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-selection">
   4. Model Selection
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#feature-engineering">
   5. Feature Engineering
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#feature-transformation">
     <strong>
      Feature Transformation
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extracting-post-originated-features">
     <strong>
      Extracting Post-Originated Features
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#combining-into-pipeline">
     <strong>
      Combining into Pipeline
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hyperparameter-optimization">
   6. Hyperparameter Optimization
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initial-hyperparameter-optimization">
     <strong>
      Initial Hyperparameter Optimization
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analyzing-optimization-results">
     <strong>
      Analyzing Optimization Results
     </strong>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#zooming-the-hyperparameters">
     <strong>
      Zooming the Hyperparameters
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-implementation-selecting-profitable-loan">
   7. Model Implementation: Selecting Profitable Loan
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preparation">
     7.1. Preparation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#strategy">
       <strong>
        Strategy
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#preparing-the-data">
       <strong>
        Preparing the Data
       </strong>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#develop-the-selectors-and-optimization-process">
     7.2. Develop the
     <code class="docutils literal notranslate">
      <span class="pre">
       Selectors
      </span>
     </code>
     and Optimization Process
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#knapsack-problem-and-solving-using-pyomo">
       <strong>
        Knapsack Problem and Solving using
        <em>
         Pyomo
        </em>
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#selector-a">
       <strong>
        Selector A
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#selector-b">
       <strong>
        Selector B
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#selector-c">
       <strong>
        Selector C
       </strong>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#selector-d">
       <strong>
        Selector D
       </strong>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#comparation-of-selector-performance">
     7.3. Comparation of
     <code class="docutils literal notranslate">
      <span class="pre">
       Selector
      </span>
     </code>
     Performance
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#final-words">
   8. Final Words
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="implementing-machine-learning-model-to-predict-and-select-loan">
<h1>Implementing Machine Learning Model to Predict and Select Loan<a class="headerlink" href="#implementing-machine-learning-model-to-predict-and-select-loan" title="Permalink to this headline">#</a></h1>
<section id="case-example-lendingclub-loan-data">
<h2><em>Case Example: LendingClub Loan Data</em><a class="headerlink" href="#case-example-lendingclub-loan-data" title="Permalink to this headline">#</a></h2>
<section id="contents">
<h3>Contents<a class="headerlink" href="#contents" title="Permalink to this headline">#</a></h3>
<p><strong><a class="reference external" href="#1_introduction">1. Introduction</a></strong></p>
<p><strong><a class="reference external" href="#2-dataset-preparation">2. Dataset Preparation</a></strong></p>
<p><strong><a class="reference external" href="#3-features-preparation">3. Features Preparation</a></strong></p>
<p><strong><a class="reference external" href="#4-model-selection">4. Model Selection</a></strong></p>
<p><strong><a class="reference external" href="#5-fature-engineering">5. Feature Engineering</a></strong></p>
<p><strong><a class="reference external" href="#6-hyperparameter">6. Hyperparameter Optimization</a></strong></p>
<p><strong><a class="reference external" href="#7-model-implementation">7. Model Implementation: Selecting Profitable Loan</a></strong></p>
<p><strong><a class="reference external" href="#7.1-preparation">7.1. Preparation</a></strong></p>
<p><strong><a class="reference external" href="#7.2-develop-selectors">7.2. Knapsack Problem and Solving using <em>Pyomo</em></a></strong></p>
<p><strong><a class="reference external" href="#7.3-comparations">7.3. Comparation of each Selector Performance</a></strong></p>
<p><strong><a class="reference external" href="#8-final-words">8. Final Words</a></strong></p>
<p><a id="1_introduction"> </a></p>
</section>
</section>
<section id="introduction">
<h2>1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>In a particular day, a coworker introduced you to a website, called <em>LendingClub Loan</em>, a loan marketplace which allow you to purchase loans individually in a hope to yield a profit from its interest. Having spare money, you decided to take a look at what it provides. You overwhelmed with the list of loans to choose, alongside with loan profile as well as borrowers’ financial profile and history. Maybe you can look at the loan rating but is it enough to decide whether the loan will yield profit or maybe defaulted?</p>
<p>Executing an informed-decision by gathering and evaluation some of relevant information must help us to reduce the risk of regret, but sometimes is highly time-consuming. In this occasion, I will demonstrate an acitivity to develop a machine learning model for solving classification problem, that may serves as <em>decision support system</em>. I will utilize LendingClub Loan data as an example in this analysis.</p>
<p><em>P.S. Individual Loan is currently not available at LendingClub Loan. Above narration is provided just to describe the situation that related to the dataset.</em></p>
<section id="what-to-do">
<h3><strong>What to Do?</strong><a class="headerlink" href="#what-to-do" title="Permalink to this headline">#</a></h3>
<p>To help deciding whether particular loans will yield profit or has a chance of default, we will develop a classification model that train from the data of LendingClub Loan from the past. The model shall be able to predict the quality of the loan.</p>
<p>We will perform some activity that commonly involved in model development, from preparation of training instances, selecting possible model that potential, tweaking our data, until optimizing the model’s parameters. Later, we will explore some ways to utilize information that can be retrieved from the model and finalize the method of loan selection.</p>
</section>
<section id="related-notebooks">
<h3><strong>Related Notebooks</strong><a class="headerlink" href="#related-notebooks" title="Permalink to this headline">#</a></h3>
</section>
<section id="performance-evaluation-of-model">
<h3><strong>Performance Evaluation of Model</strong><a class="headerlink" href="#performance-evaluation-of-model" title="Permalink to this headline">#</a></h3>
<p>In general, the model should be able to predict if the loan is <em>Good Loan</em> or <em>Bad Loan</em>. Let’s see below confusion matrix of our prediction:</p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>Actual/Prediction</th>
      <th>Good Loan [0]</th>
      <th>Bad Loan [1]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Good loan [0]</th>
      <td>TN</td>
      <td>FP</td>
    </tr>
    <tr>
      <th>Bad Loan [1]</th>
      <td>FN</td>
      <td>TP</td>
    </tr>
  </tbody>
</table><p>So, what metric shall we use for our model? Consider this:</p>
<ul class="simple">
<li><p>We want model to be able to detect most of (if not all) possibly defaulted loan as much. For example, if there would be 10 loan to be defaulted, our model would be reliable  if most of those loan is tagged as <code class="docutils literal notranslate"><span class="pre">Bad</span> <span class="pre">Loan</span></code>. The metric is <strong>sensitivity</strong> (or <em>True Positive Rate</em>): the ratio of positive instances that are correctly detected by the model,
$<span class="math notranslate nohighlight">\(sensitivity/TPR=\frac{TP}{FN + TP}\)</span>$</p></li>
<li><p>In an extreme case, <strong>TPR</strong> can be inflated by a model that tag all of the loan as <code class="docutils literal notranslate"><span class="pre">Bad</span> <span class="pre">Loan</span></code>, resulting in a huge number of <em>False Positive</em> prediction: most of the <code class="docutils literal notranslate"><span class="pre">Good</span> <span class="pre">Loan</span></code> tagged as <code class="docutils literal notranslate"><span class="pre">Bad</span> <span class="pre">Loan</span></code>. Therefore, another metric to watch is <strong>FPR</strong> (or <em>False Positive Rate</em>): the ratio of negative instance that are incorrectly tagged as positive instance,
$<span class="math notranslate nohighlight">\(FPR=\frac{FP}{TN + FP}\)</span>$</p></li>
<li><p>TPR is the ability of the model to detect potential loss, which should be avoided. On the other side, FPR is the consequence of its high sensitivity to positive instance, in our cases, we would miss potential profit. We want to optimize trade-off between both metrics. They are commonly considered in <strong>Receiver Operating Characteristic</strong> (ROC): Comparation of <em>TPR</em> and <em>FPR</em>.</p></li>
</ul>
<p><a id="2-dataset-preparation"> </a></p>
</section>
</section>
<section id="dataset-preparation">
<h2>2. Dataset Preparation<a class="headerlink" href="#dataset-preparation" title="Permalink to this headline">#</a></h2>
<section id="the-dataset">
<h3><strong>The Dataset</strong><a class="headerlink" href="#the-dataset" title="Permalink to this headline">#</a></h3>
<p>We already prepared the exclusively for training and testing:</p>
<ul class="simple">
<li><p>Dataset for training: Loan Dataset of 2010 - 2015</p></li>
<li><p>Dataset for testing: Loan Dataset of 2016 - 2017</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># plotting</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1"># iteration checking</span>

<span class="c1"># base setting</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="s1">&#39;ERROR&#39;</span>
<span class="c1"># import data</span>
<span class="n">train_set</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;dataset\lc_2010-2015.csv&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="s1">&#39;verification_status_joint&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">})</span>
<span class="n">test_set</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;dataset\lc_2016-2017.csv&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="s1">&#39;verification_status_joint&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">Temp</span>\<span class="n">ipykernel_10312</span>\<span class="mf">2017832883.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="c1"># plotting</span>
<span class="ne">----&gt; </span><span class="mi">4</span> <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="ne">D</span>:\anaconda3\envs\general_ds\lib\site-packages\seaborn\__init__.py in &lt;module&gt;
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Import seaborn objects</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="kn">from</span> <span class="nn">.rcmod</span> <span class="kn">import</span> <span class="o">*</span>  <span class="c1"># noqa: F401,F403</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="o">*</span>  <span class="c1"># noqa: F401,F403</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">from</span> <span class="nn">.palettes</span> <span class="kn">import</span> <span class="o">*</span>  <span class="c1"># noqa: F401,F403</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="kn">from</span> <span class="nn">.relational</span> <span class="kn">import</span> <span class="o">*</span>  <span class="c1"># noqa: F401,F403</span>

<span class="ne">D</span>:\anaconda3\envs\general_ds\lib\site-packages\seaborn\rcmod.py in &lt;module&gt;
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="kn">from</span> <span class="nn">cycler</span> <span class="kn">import</span> <span class="n">cycler</span>
<span class="ne">----&gt; </span><span class="mi">7</span> <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">palettes</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> 
<span class="g g-Whitespace">      </span><span class="mi">9</span> 

<span class="ne">D</span>:\anaconda3\envs\general_ds\lib\site-packages\seaborn\palettes.py in &lt;module&gt;
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="kn">from</span> <span class="nn">.external</span> <span class="kn">import</span> <span class="n">husl</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> 
<span class="ne">----&gt; </span><span class="mi">9</span> <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">desaturate</span><span class="p">,</span> <span class="n">get_color_cycle</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="kn">from</span> <span class="nn">.colors</span> <span class="kn">import</span> <span class="n">xkcd_rgb</span><span class="p">,</span> <span class="n">crayons</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> 

<span class="ne">D</span>:\anaconda3\envs\general_ds\lib\site-packages\seaborn\utils.py in &lt;module&gt;
<span class="g g-Whitespace">      </span><span class="mi">8</span> 
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="ne">---&gt; </span><span class="mi">10</span> <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

<span class="nn">D:\anaconda3\envs\general_ds\lib\importlib\_bootstrap.py</span> in <span class="ni">_handle_fromlist</span><span class="nt">(module, fromlist, import_, recursive)</span>

<span class="nn">D:\anaconda3\envs\general_ds\lib\site-packages\scipy\__init__.py</span> in <span class="ni">__getattr__</span><span class="nt">(name)</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span>     <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>         <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">submodules</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">211</span>             <span class="k">return</span> <span class="n">_importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;scipy.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">212</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>             <span class="k">try</span><span class="p">:</span>

<span class="nn">D:\anaconda3\envs\general_ds\lib\importlib\__init__.py</span> in <span class="ni">import_module</span><span class="nt">(name, package)</span>
<span class="g g-Whitespace">    </span><span class="mi">125</span>                 <span class="k">break</span>
<span class="g g-Whitespace">    </span><span class="mi">126</span>             <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="ne">--&gt; </span><span class="mi">127</span>     <span class="k">return</span> <span class="n">_bootstrap</span><span class="o">.</span><span class="n">_gcd_import</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">level</span><span class="p">:],</span> <span class="n">package</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">128</span> 
<span class="g g-Whitespace">    </span><span class="mi">129</span> 

<span class="ne">D</span>:\anaconda3\envs\general_ds\lib\site-packages\scipy\stats\__init__.py in &lt;module&gt;
<span class="g g-Whitespace">    </span><span class="mi">465</span> <span class="kn">from</span> <span class="nn">._warnings_errors</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ConstantInputWarning</span><span class="p">,</span> <span class="n">NearConstantInputWarning</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">466</span>                                <span class="n">DegenerateDataWarning</span><span class="p">,</span> <span class="n">FitError</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">467</span> <span class="kn">from</span> <span class="nn">._stats_py</span> <span class="kn">import</span> <span class="o">*</span>
<span class="g g-Whitespace">    </span><span class="mi">468</span> <span class="kn">from</span> <span class="nn">._variation</span> <span class="kn">import</span> <span class="n">variation</span>
<span class="g g-Whitespace">    </span><span class="mi">469</span> <span class="kn">from</span> <span class="nn">.distributions</span> <span class="kn">import</span> <span class="o">*</span>

<span class="ne">D</span>:\anaconda3\envs\general_ds\lib\site-packages\scipy\stats\_stats_py.py in &lt;module&gt;
<span class="g g-Whitespace">     </span><span class="mi">37</span> <span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">suppress_warnings</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span> 
<span class="ne">---&gt; </span><span class="mi">39</span> <span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span> <span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">_measurements</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span> <span class="kn">from</span> <span class="nn">scipy._lib._util</span> <span class="kn">import</span> <span class="p">(</span><span class="n">check_random_state</span><span class="p">,</span> <span class="n">MapWrapper</span><span class="p">,</span>

<span class="ne">D</span>:\anaconda3\envs\general_ds\lib\site-packages\scipy\spatial\__init__.py in &lt;module&gt;
<span class="g g-Whitespace">    </span><span class="mi">103</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">104</span><span class="s2"> </span>
<span class="ne">--&gt; </span><span class="mi">105</span><span class="s2"> from ._kdtree import *</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="s2"> from ._ckdtree import *</span>
<span class="g g-Whitespace">    </span><span class="mi">107</span><span class="s2"> from ._qhull import *</span>

<span class="ne">D</span>:\anaconda3\envs\general_ds\lib\site-packages\scipy\spatial\_kdtree.py in &lt;module&gt;
<span class="g g-Whitespace">      </span><span class="mi">3</span><span class="s2"> import numpy as np</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span><span class="s2"> import warnings</span>
<span class="ne">----&gt; </span><span class="mi">5</span><span class="s2"> from ._ckdtree import cKDTree, cKDTreeNode</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span><span class="s2"> </span>
<span class="g g-Whitespace">      </span><span class="mi">7</span><span class="s2"> __all__ = [&#39;minkowski_distance_p&#39;, &#39;minkowski_distance&#39;,</span>

<span class="nn">_ckdtree.pyx</span> in <span class="ni">init scipy.spatial._ckdtree</span><span class="nt">()</span>

<span class="ne">D</span>:\anaconda3\envs\general_ds\lib\site-packages\scipy\sparse\__init__.py in &lt;module&gt;
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> from ._coo import *</span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> from ._dia import *</span>
<span class="ne">--&gt; </span><span class="mi">273</span><span class="s2"> from ._bsr import *</span>
<span class="g g-Whitespace">    </span><span class="mi">274</span><span class="s2"> from ._construct import *</span>
<span class="g g-Whitespace">    </span><span class="mi">275</span><span class="s2"> from ._extract import *</span>

<span class="nn">D:\anaconda3\envs\general_ds\lib\importlib\_bootstrap.py</span> in <span class="ni">_find_and_load</span><span class="nt">(name, import_)</span>

<span class="nn">D:\anaconda3\envs\general_ds\lib\importlib\_bootstrap.py</span> in <span class="ni">_find_and_load_unlocked</span><span class="nt">(name, import_)</span>

<span class="nn">D:\anaconda3\envs\general_ds\lib\importlib\_bootstrap.py</span> in <span class="ni">_load_unlocked</span><span class="nt">(spec)</span>

<span class="nn">D:\anaconda3\envs\general_ds\lib\importlib\_bootstrap_external.py</span> in <span class="ni">exec_module</span><span class="nt">(self, module)</span>

<span class="nn">D:\anaconda3\envs\general_ds\lib\importlib\_bootstrap_external.py</span> in <span class="ni">get_code</span><span class="nt">(self, fullname)</span>

<span class="nn">D:\anaconda3\envs\general_ds\lib\importlib\_bootstrap_external.py</span> in <span class="ni">get_data</span><span class="nt">(self, path)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
</section>
<section id="preparing-the-dataset">
<h3><strong>Preparing the Dataset</strong><a class="headerlink" href="#preparing-the-dataset" title="Permalink to this headline">#</a></h3>
<p>In this first part of dataset preparation, we will create a pipeline to transform the dataset which consists of:</p>
<ul class="simple">
<li><p>Filtering the dataset: 1) To consider only <code class="docutils literal notranslate"><span class="pre">INDIVIDUAL</span></code> loan; 2) To exclude the on-going loan</p></li>
<li><p>Replacing missing values, as explained in previous section.</p></li>
</ul>
<p>I already developed classes for each of the activity: 1) <code class="docutils literal notranslate"><span class="pre">LoanDataLabelPredictor</span></code> for filtering; 2) <code class="docutils literal notranslate"><span class="pre">LoanDataMissingHandler</span></code> to handle missing data, according to explanation in previous chapter. The output of the pipeline is splitted predictor-label set.</p>
<div class="cell tag_hide-input tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">modules.data_preprocess</span> <span class="kn">import</span> <span class="n">LoanDataPreprocess</span><span class="p">,</span> <span class="n">LoanDataMissingHandler</span><span class="p">,</span> <span class="n">LoanDataLabelPredictor</span> 
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">set_config</span>

<span class="n">dataset_preprocess</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocess&#39;</span><span class="p">,</span> <span class="n">LoanDataPreprocess</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;extract_label_predictor&#39;</span><span class="p">,</span> <span class="n">LoanDataLabelPredictor</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loan_amnt&#39;</span><span class="p">,</span> <span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="s1">&#39;earliest_cr_line&#39;</span><span class="p">])),</span>
    <span class="p">(</span><span class="s1">&#39;missing_handler&#39;</span><span class="p">,</span> <span class="n">LoanDataMissingHandler</span><span class="p">())</span>
    <span class="p">])</span>

<span class="n">set_config</span><span class="p">(</span><span class="n">display</span><span class="o">=</span><span class="s1">&#39;diagram&#39;</span><span class="p">)</span>
<span class="n">dataset_preprocess</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>#sk-container-id-2 {color: black;background-color: white;}#sk-container-id-2 pre{padding: 0;}#sk-container-id-2 div.sk-toggleable {background-color: white;}#sk-container-id-2 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-2 label.sk-toggleable__label-arrow:before {content: "â–¸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-2 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-2 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-2 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "â–¾";}#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-2 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-2 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-2 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-2 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-2 div.sk-item {position: relative;z-index: 1;}#sk-container-id-2 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-2 div.sk-item::before, #sk-container-id-2 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-2 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-2 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-2 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-2 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-2 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-2 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-2 div.sk-label-container {text-align: center;}#sk-container-id-2 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-2 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-2" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[(&#x27;preprocess&#x27;, LoanDataPreprocess()),
                (&#x27;extract_label_predictor&#x27;,
                 LoanDataLabelPredictor(exclude=[&#x27;loan_amnt&#x27;, &#x27;term&#x27;,
                                                 &#x27;earliest_cr_line&#x27;])),
                (&#x27;missing_handler&#x27;, LoanDataMissingHandler())])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-5" type="checkbox" ><label for="sk-estimator-id-5" class="sk-toggleable__label sk-toggleable__label-arrow">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[(&#x27;preprocess&#x27;, LoanDataPreprocess()),
                (&#x27;extract_label_predictor&#x27;,
                 LoanDataLabelPredictor(exclude=[&#x27;loan_amnt&#x27;, &#x27;term&#x27;,
                                                 &#x27;earliest_cr_line&#x27;])),
                (&#x27;missing_handler&#x27;, LoanDataMissingHandler())])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-6" type="checkbox" ><label for="sk-estimator-id-6" class="sk-toggleable__label sk-toggleable__label-arrow">LoanDataPreprocess</label><div class="sk-toggleable__content"><pre>LoanDataPreprocess()</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-7" type="checkbox" ><label for="sk-estimator-id-7" class="sk-toggleable__label sk-toggleable__label-arrow">LoanDataLabelPredictor</label><div class="sk-toggleable__content"><pre>LoanDataLabelPredictor(exclude=[&#x27;loan_amnt&#x27;, &#x27;term&#x27;, &#x27;earliest_cr_line&#x27;])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-8" type="checkbox" ><label for="sk-estimator-id-8" class="sk-toggleable__label sk-toggleable__label-arrow">LoanDataMissingHandler</label><div class="sk-toggleable__content"><pre>LoanDataMissingHandler()</pre></div></div></div></div></div></div></div></div></div>
</div>
<p>Checking the missing data:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">modules.data_exploration</span> <span class="kn">import</span> <span class="n">DataExploration</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">dataset_preprocess</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_set</span><span class="p">)</span>
<span class="n">DataExploration</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">show_nans_or_zeroes</span><span class="p">(</span><span class="s1">&#39;nans&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Nans Count</th>
      <th>Nans Percentage (%)</th>
      <th>Data Types</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>emp_length</th>
      <td>9132</td>
      <td>4.34</td>
      <td>category</td>
    </tr>
    <tr>
      <th>home_ownership</th>
      <td>0</td>
      <td>0.00</td>
      <td>category</td>
    </tr>
    <tr>
      <th>annual_inc</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>verification_status</th>
      <td>0</td>
      <td>0.00</td>
      <td>category</td>
    </tr>
    <tr>
      <th>dti</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>delinq_2yrs</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>inq_last_6mths</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>mths_since_last_delinq</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>mths_since_last_record</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>open_acc</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>revol_bal</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>revol_util</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>total_acc</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>collections_12_mths_ex_med</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>mths_since_last_major_derog</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>policy_code</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>acc_now_delinq</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>tot_coll_amt</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>tot_cur_bal</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>open_acc_6m</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>open_il_12m</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>open_il_24m</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>mths_since_rcnt_il</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>total_bal_il</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>il_util</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>open_rv_12m</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>open_rv_24m</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>all_util</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>total_rev_hi_lim</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>inq_fi</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>total_cu_tl</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>inq_last_12m</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>pub_rec</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>max_bal_bc</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>int_rate</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>installment</th>
      <td>0</td>
      <td>0.00</td>
      <td>float64</td>
    </tr>
    <tr>
      <th>grade</th>
      <td>0</td>
      <td>0.00</td>
      <td>category</td>
    </tr>
    <tr>
      <th>sub_grade</th>
      <td>0</td>
      <td>0.00</td>
      <td>category</td>
    </tr>
    <tr>
      <th>pymnt_plan</th>
      <td>0</td>
      <td>0.00</td>
      <td>category</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">dataset_preprocess</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_set</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Based on previous confusion matrix, we will map the label as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">map_array</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;Good Loan&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="mi">1</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">map_array</span><span class="p">)(</span><span class="n">y_train</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">map_array</span><span class="p">)(</span><span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id="3-features-preparation"> </a></p>
</section>
</section>
<section id="features-preparation">
<h2>3. Features Preparation<a class="headerlink" href="#features-preparation" title="Permalink to this headline">#</a></h2>
<section id="categorical-features">
<h3><strong>Categorical Features</strong><a class="headerlink" href="#categorical-features" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>

<span class="n">one_hot</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="numerical-features">
<h3><strong>Numerical Features</strong><a class="headerlink" href="#numerical-features" title="Permalink to this headline">#</a></h3>
<p>For our base model, let’s first just consider scaling the features. This is commonly a standard practice and may turns out to give a proper result for several estimator. However, scaling is not necessary for <code class="docutils literal notranslate"><span class="pre">logistic</span> <span class="pre">regression</span></code> and tree-based method.</p>
<p>For dataset which has outliers, scikit-learn provides scaling that robust to this condition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">RobustScaler</span>

<span class="n">robust_scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="combining-feature-preprocess">
<h3><strong>Combining Feature Preprocess</strong><a class="headerlink" href="#combining-feature-preprocess" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>

<span class="n">categorical_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;categorical&#39;</span><span class="p">,</span> <span class="n">one_hot</span><span class="p">,</span> <span class="n">categorical_cols</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;numerical&#39;</span><span class="p">,</span> <span class="n">robust_scaler</span><span class="p">,</span> <span class="n">numerical_cols</span><span class="p">)</span>
    <span class="p">])</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="n">transform</span><span class="o">=</span><span class="s1">&#39;pandas&#39;</span><span class="p">)</span>
<span class="n">ct</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_train_transfd</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_transfd</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id="4-model-selection"> </a></p>
</section>
</section>
<section id="model-selection">
<h2>4. Model Selection<a class="headerlink" href="#model-selection" title="Permalink to this headline">#</a></h2>
<p>Now we are going to identify several potential models for our classification task!
For each potential model, we are going to observe how the model performs by comparing the model performance, focusing on <code class="docutils literal notranslate"><span class="pre">AUC</span></code> score of <code class="docutils literal notranslate"><span class="pre">Bad</span> <span class="pre">Loan</span></code> class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedShuffleSplit</span><span class="p">,</span> <span class="n">cross_val_score</span>
<span class="c1"># classifier</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="c1"># scoring</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">make_scorer</span>

<span class="c1"># classifier</span>
<span class="n">log_clf</span>  <span class="o">=</span>  <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span> <span class="c1"># linear</span>
<span class="n">knn_clf</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">()</span> <span class="c1"># distance-based</span>
<span class="n">rf_clf</span>  <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span> <span class="c1"># stochastic, ensemble</span>
<span class="n">xgb_clf</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,)</span> <span class="c1">#boosting</span>
<span class="c1"># initialize an empty list to store the scores</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">log_clf</span><span class="p">,</span> <span class="n">knn_clf</span><span class="p">,</span> <span class="n">rf_clf</span><span class="p">,</span> <span class="n">xgb_clf</span><span class="p">]</span>
<span class="n">scoring_method</span> <span class="o">=</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">needs_proba</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># returns callable in form of scorer(estimator, X, y)</span>
<span class="c1"># iterate over the models</span>
<span class="k">def</span> <span class="nf">cross_val_evaluation</span><span class="p">(</span><span class="n">models</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">scoring_method</span><span class="p">:</span><span class="n">callable</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="n">model_scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
            <span class="n">scoring</span> <span class="o">=</span> <span class="n">scoring_method</span><span class="p">,</span> <span class="c1">#scorer(estimator, X, y)</span>
            <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedShuffleSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># calculate the mean and standard deviation of the scores</span>
        <span class="c1"># this is model-specific</span>
        <span class="n">mean_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model_scores</span><span class="p">)</span>
        <span class="n">std_dev_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">model_scores</span><span class="p">)</span>
        <span class="c1"># print the mean and standard deviation of the scores</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: Mean score = </span><span class="si">{</span><span class="n">mean_score</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, Standard deviation = </span><span class="si">{</span><span class="n">std_dev_score</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">cross_val_evaluation</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">X_train_transfd</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">scoring_method</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 25%|â–ˆâ–ˆâ–Œ       | 1/4 [04:41&lt;14:03, 281.29s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LogisticRegression: Mean score = 0.69, Standard deviation = 0.01
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 2/4 [10:46&lt;11:00, 330.36s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KNeighborsClassifier: Mean score = 0.60, Standard deviation = 0.00
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 75%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ  | 3/4 [27:16&lt;10:31, 631.80s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RandomForestClassifier: Mean score = 0.69, Standard deviation = 0.00
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 4/4 [34:53&lt;00:00, 523.42s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>XGBClassifier: Mean score = 0.71, Standard deviation = 0.00
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<p>In above code:</p>
<ol class="simple">
<li><p>We use cross-validation to estimate test score.</p></li>
<li><p>We know that, from previous chapter, our dataset has unique proportion of <code class="docutils literal notranslate"><span class="pre">Good</span> <span class="pre">Loan</span></code> and <code class="docutils literal notranslate"><span class="pre">Bad</span> <span class="pre">Loan</span></code>. Using <code class="docutils literal notranslate"><span class="pre">StratifiedShuffleSplit</span></code>, proportion of <code class="docutils literal notranslate"><span class="pre">Good</span> <span class="pre">Loan</span></code> and <code class="docutils literal notranslate"><span class="pre">Bad</span> <span class="pre">Loan</span></code> is maintained in every split.</p></li>
<li><p>We use <code class="docutils literal notranslate"><span class="pre">roc_auc_score</span></code> as the cross-val score. The reason will be explained shortly.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plotting</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">RocCurveDisplay</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">LearningCurveDisplay</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">log_clf</span><span class="p">,</span> <span class="n">knn_clf</span><span class="p">,</span> <span class="n">rf_clf</span><span class="p">,</span> <span class="n">xgb_clf</span><span class="p">]</span>
<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_transfd</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">RocCurveDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">X_test_transfd</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
    <span class="n">LearningCurveDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">X_train_transfd</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scoring</span><span class="o">=</span><span class="n">make_scorer</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">needs_proba</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedShuffleSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> 
        <span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ROC Curve&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Learning Curve&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Learning Curve&#39;)
</pre></div>
</div>
<img alt="../_images/processed_34_1.png" src="../_images/processed_34_1.png" />
</div>
</div>
<p>Left-hand plot shows <em>ROC</em> curve and <em>AUC</em> value for each model. The <em>AUC</em> is the calculated <em>Area Under the (ROC) Curve</em>. It can be seen that, model with higher AUC has steeper curve: the <em>TPR</em> is increasing faster at lower <em>FPR</em>. In other words, models with higher AUC can obtain higher <em>TPR</em> at lower cost.</p>
<p><em>ROC</em> curves shows tradeoff between TPR and FPR along every possible categorizing <em>treshold</em> of probability that such observations is part of <code class="docutils literal notranslate"><span class="pre">Bad</span> <span class="pre">Loan</span></code> class:</p>
<div class="math notranslate nohighlight">
\[\hat{f} &lt; t\;then\;Good\;Loan\]</div>
<div class="math notranslate nohighlight">
\[\hat{f}\geq t\;then\;Bad\;Loan\]</div>
<p>where <span class="math notranslate nohighlight">\(\hat{f}\)</span> is the <em>decision function</em> and <span class="math notranslate nohighlight">\(t\)</span> is the <em>treshold</em>. This explain the reason why the rightmost side of ROC has <span class="math notranslate nohighlight">\(TPR=1\)</span> and <span class="math notranslate nohighlight">\(FPR=1\)</span>: all of the observations is labeled as <em>Bad Loan</em> by setting up the treshold value to the lowest possible <em>decision function</em> that obtained from the model.</p>
<p>So our strategy of model selection and optimization is clear: look for model with the best AUC, then we adjust the treshold so that, based on our dataset, maximize the profit (simultaneously minimize the potential loss).</p>
<p>Right-hand plot shows cross-validated learning curve for three of the models. Although we use training set, cross-validation can be used to estimate test result. The error band explains the <em>standard deviation</em> of score. We will use <em>GradientBoosting</em> since it shows promising performance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># df to plot</span>
<span class="k">def</span> <span class="nf">plot_importance</span><span class="p">(</span><span class="n">fitted_model</span><span class="p">):</span>
    <span class="n">feature_importances</span> <span class="o">=</span> <span class="n">fitted_model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">fitted_model</span><span class="o">.</span><span class="n">feature_names_in_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">feature_importances</span><span class="p">],</span> 
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;feature_name&#39;</span><span class="p">,</span> <span class="s1">&#39;importance&#39;</span><span class="p">])</span>
    <span class="n">importance_df</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">feature_name</span><span class="o">=</span><span class="n">importance_df</span><span class="o">.</span><span class="n">feature_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">importance</span><span class="o">=</span><span class="n">importance_df</span><span class="o">.</span><span class="n">importance</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;feature_name&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">importance_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">20</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">y_</span><span class="p">,</span> <span class="n">x_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">20</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">importance</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">x_</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">),</span> 
            <span class="n">y</span><span class="o">=</span><span class="n">y_</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_</span><span class="si">:</span><span class="s1">,.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span>
            <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Feature Importance, </span><span class="si">{</span><span class="n">fitted_model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xgb_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_transfd</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">plot_importance</span><span class="p">(</span><span class="n">xgb_clf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/processed_37_0.png" src="../_images/processed_37_0.png" />
</div>
</div>
<p><a id="5-fature-engineering"> </a></p>
</section>
<section id="feature-engineering">
<h2>5. Feature Engineering<a class="headerlink" href="#feature-engineering" title="Permalink to this headline">#</a></h2>
<section id="feature-transformation">
<h3><strong>Feature Transformation</strong><a class="headerlink" href="#feature-transformation" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PowerTransformer</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

<span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loan_category&#39;</span><span class="p">])</span>
<span class="n">transformer_scaler</span> <span class="o">=</span> <span class="n">PowerTransformer</span><span class="p">(</span><span class="n">standardize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="n">transform</span><span class="o">=</span><span class="s1">&#39;pandas&#39;</span><span class="p">)</span>
<span class="n">train_set_</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[[</span><span class="s1">&#39;annual_inc&#39;</span><span class="p">,</span> <span class="s1">&#39;dti&#39;</span><span class="p">]]</span>
<span class="n">train_set_transfd</span> <span class="o">=</span> <span class="n">transformer_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_set_</span><span class="p">)</span>
<span class="c1"># merge with label</span>
<span class="n">train_set_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">train_set_</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
<span class="n">train_set_transfd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">train_set_transfd</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
<span class="c1"># plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">train_set_</span><span class="p">,</span> <span class="n">train_set_transfd</span><span class="p">]):</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">ax_histx</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">ax_histx</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;annual_inc&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_histx</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;loan_category&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_histx</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_histx</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_histy</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">ax_histy</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;dti&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_histy</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;loan_category&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_histy</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_histy</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;annual_inc&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;dti&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;loan_category&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Power Tranformation of `annual_inc` and `dti`&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>d:\anaconda3\envs\general_ds\lib\site-packages\IPython\core\pylabtools.py:137: UserWarning: Creating legend with loc=&quot;best&quot; can be slow with large amounts of data.
  fig.canvas.print_figure(bytes_io, **kw)
</pre></div>
</div>
<img alt="../_images/processed_40_1.png" src="../_images/processed_40_1.png" />
</div>
</div>
<p>Plot above shows an example of power transformation using <code class="docutils literal notranslate"><span class="pre">PowerTransformer</span> <span class="pre">(yeo-johnson)</span></code>. See how outliers handled without explicitly removing them: by “compressing” the distribution, differences between large values become smaller hence the heavy influence may be suppressed. The data become more balanced in the hope of mitigate outliers impact.</p>
<blockquote>
<div><p>In a very skewed dataset like this, the outliers must be treated carefully and the impact shall be analyzed further. Simply removing them may influence the analysis, what if the evidence reflects the nature of the population? Subject-matter-expect, helped with more sophisticated method may still be required, but the computation cost is of course more expensive.</p>
</div></blockquote>
</section>
<section id="extracting-post-originated-features">
<h3><strong>Extracting Post-Originated Features</strong><a class="headerlink" href="#extracting-post-originated-features" title="Permalink to this headline">#</a></h3>
<p>From previous chapter, we observed a pattern of <code class="docutils literal notranslate"><span class="pre">average</span> <span class="pre">portion</span> <span class="pre">paid</span></code> of bad loan which is associated according to its categorized loan <code class="docutils literal notranslate"><span class="pre">grade</span></code>. We will implement this extraction as below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span>

<span class="k">class</span> <span class="nc">LoanFeatureExtract</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">portion_paid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">total_rec_prncp</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">loan_amnt</span>
            <span class="p">)</span>
        <span class="n">bad_loan_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="s1">&#39;Bad Loan&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">map_loan_cat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Good Loan&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Bad Loan&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg_defaulted_recovery_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">bad_loan_mask</span><span class="p">,</span> <span class="p">:]</span>\
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;sub_grade&#39;</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">avg_defaulted_recovery</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;portion_paid&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">))</span>\
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portion_defaulted_</span> <span class="o">=</span> \
            <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">X</span><span class="p">[[</span><span class="s1">&#39;sub_grade&#39;</span><span class="p">]],</span> 
                     <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;loan_category&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">map_loan_cat</span><span class="p">)),</span> 
                     <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;sub_grade&#39;</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">avg_portion_defaulted</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;loan_category&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">))</span>\
                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_defaulted_recovery_</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;sub_grade&#39;</span>
            <span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">portion_defaulted_</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;sub_grade&#39;</span>
            <span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_rec_prncp&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">X</span>
</pre></div>
</div>
</div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">avg_defaulted_recovery_</span></code> (and others) is served as <em>fitted attribute</em> of this transformer  . The advantage of creating this transformer is to assure that there won’t be data leakage from <code class="docutils literal notranslate"><span class="pre">test</span> <span class="pre">set</span></code>, since the <code class="docutils literal notranslate"><span class="pre">self.avg_defaulted_recovery_</span></code> is only updated using <code class="docutils literal notranslate"><span class="pre">fit</span></code> method (refer to <em>scikit-learn</em> documentation on how this attribute won’t be updated by <code class="docutils literal notranslate"><span class="pre">transform</span></code> method).</p>
<p>In above extraction, we try to increases the dataset knowledge regarding the <code class="docutils literal notranslate"><span class="pre">Bad</span> <span class="pre">Loan</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_preprocess</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocess&#39;</span><span class="p">,</span> <span class="n">LoanDataPreprocess</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;extract_label_predictor&#39;</span><span class="p">,</span> <span class="n">LoanDataLabelPredictor</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;earliest_cr_line&#39;</span><span class="p">,</span> <span class="s1">&#39;pymnt_plan&#39;</span><span class="p">,</span> <span class="s1">&#39;policy_code&#39;</span><span class="p">],</span> 
                                                       <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_rec_prncp&#39;</span><span class="p">])),</span>
    <span class="p">(</span><span class="s1">&#39;missing_handler&#39;</span><span class="p">,</span> <span class="n">LoanDataMissingHandler</span><span class="p">()),</span>
    <span class="p">])</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">dataset_preprocess</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_set</span><span class="p">)</span>
<span class="n">extract_feature</span> <span class="o">=</span> <span class="n">LoanFeatureExtract</span><span class="p">()</span>
<span class="n">extract_feature</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
      <th>13</th>
      <th>14</th>
      <th>15</th>
      <th>16</th>
      <th>17</th>
      <th>18</th>
      <th>19</th>
      <th>20</th>
      <th>21</th>
      <th>22</th>
      <th>23</th>
      <th>24</th>
      <th>25</th>
      <th>26</th>
      <th>27</th>
      <th>28</th>
      <th>29</th>
      <th>30</th>
      <th>31</th>
      <th>32</th>
      <th>33</th>
      <th>34</th>
      <th>35</th>
      <th>36</th>
      <th>...</th>
      <th>210369</th>
      <th>210370</th>
      <th>210371</th>
      <th>210372</th>
      <th>210373</th>
      <th>210374</th>
      <th>210375</th>
      <th>210376</th>
      <th>210377</th>
      <th>210378</th>
      <th>210379</th>
      <th>210380</th>
      <th>210381</th>
      <th>210382</th>
      <th>210383</th>
      <th>210384</th>
      <th>210385</th>
      <th>210386</th>
      <th>210387</th>
      <th>210388</th>
      <th>210389</th>
      <th>210390</th>
      <th>210391</th>
      <th>210392</th>
      <th>210393</th>
      <th>210394</th>
      <th>210395</th>
      <th>210396</th>
      <th>210397</th>
      <th>210398</th>
      <th>210399</th>
      <th>210400</th>
      <th>210401</th>
      <th>210402</th>
      <th>210403</th>
      <th>210404</th>
      <th>210405</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>emp_length</th>
      <td>more 10 years</td>
      <td>more 10 years</td>
      <td>5 years</td>
      <td>more 10 years</td>
      <td>2 years</td>
      <td>4 years</td>
      <td>more 10 years</td>
      <td>2 years</td>
      <td>more 10 years</td>
      <td>more 10 years</td>
      <td>4 years</td>
      <td>more 10 years</td>
      <td>5 years</td>
      <td>9 years</td>
      <td>less 1 year</td>
      <td>less 1 year</td>
      <td>8 years</td>
      <td>2 years</td>
      <td>more 10 years</td>
      <td>1 year</td>
      <td>more 10 years</td>
      <td>5 years</td>
      <td>2 years</td>
      <td>more 10 years</td>
      <td>less 1 year</td>
      <td>3 years</td>
      <td>7 years</td>
      <td>more 10 years</td>
      <td>more 10 years</td>
      <td>5 years</td>
      <td>more 10 years</td>
      <td>1 year</td>
      <td>8 years</td>
      <td>3 years</td>
      <td>7 years</td>
      <td>more 10 years</td>
      <td>more 10 years</td>
      <td>...</td>
      <td>1 year</td>
      <td>3 years</td>
      <td>more 10 years</td>
      <td>more 10 years</td>
      <td>NaN</td>
      <td>3 years</td>
      <td>4 years</td>
      <td>more 10 years</td>
      <td>1 year</td>
      <td>6 years</td>
      <td>2 years</td>
      <td>4 years</td>
      <td>less 1 year</td>
      <td>5 years</td>
      <td>5 years</td>
      <td>less 1 year</td>
      <td>more 10 years</td>
      <td>more 10 years</td>
      <td>more 10 years</td>
      <td>more 10 years</td>
      <td>5 years</td>
      <td>3 years</td>
      <td>8 years</td>
      <td>9 years</td>
      <td>NaN</td>
      <td>2 years</td>
      <td>5 years</td>
      <td>6 years</td>
      <td>NaN</td>
      <td>3 years</td>
      <td>4 years</td>
      <td>more 10 years</td>
      <td>more 10 years</td>
      <td>less 1 year</td>
      <td>2 years</td>
      <td>more 10 years</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>home_ownership</th>
      <td>RENT</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>RENT</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>OWN</td>
      <td>MORTGAGE</td>
      <td>RENT</td>
      <td>OWN</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>RENT</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>OWN</td>
      <td>MORTGAGE</td>
      <td>RENT</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>RENT</td>
      <td>RENT</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>OWN</td>
      <td>...</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>OWN</td>
      <td>MORTGAGE</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>OWN</td>
      <td>MORTGAGE</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>OWN</td>
      <td>MORTGAGE</td>
      <td>OWN</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>OWN</td>
      <td>RENT</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>MORTGAGE</td>
      <td>RENT</td>
      <td>RENT</td>
      <td>MORTGAGE</td>
      <td>OWN</td>
    </tr>
    <tr>
      <th>annual_inc</th>
      <td>40000.00</td>
      <td>25000.00</td>
      <td>325000.00</td>
      <td>100000.00</td>
      <td>33000.00</td>
      <td>32760.00</td>
      <td>98000.00</td>
      <td>39600.00</td>
      <td>81500.00</td>
      <td>41000.00</td>
      <td>70000.00</td>
      <td>80000.00</td>
      <td>25000.00</td>
      <td>45000.00</td>
      <td>175000.00</td>
      <td>112000.00</td>
      <td>115000.00</td>
      <td>60000.00</td>
      <td>67000.00</td>
      <td>70000.00</td>
      <td>84000.00</td>
      <td>50000.00</td>
      <td>55000.00</td>
      <td>41600.00</td>
      <td>38000.00</td>
      <td>60000.00</td>
      <td>90000.00</td>
      <td>74628.00</td>
      <td>102120.00</td>
      <td>90000.00</td>
      <td>60000.00</td>
      <td>38000.00</td>
      <td>250000.00</td>
      <td>50000.00</td>
      <td>87500.00</td>
      <td>56000.00</td>
      <td>180000.00</td>
      <td>...</td>
      <td>35370.00</td>
      <td>45000.00</td>
      <td>40160.00</td>
      <td>80000.00</td>
      <td>40000.00</td>
      <td>80000.00</td>
      <td>262000.00</td>
      <td>84000.00</td>
      <td>65000.00</td>
      <td>38000.00</td>
      <td>27000.00</td>
      <td>55000.00</td>
      <td>60000.00</td>
      <td>74000.00</td>
      <td>57200.00</td>
      <td>252000.00</td>
      <td>76584.00</td>
      <td>100000.00</td>
      <td>62000.00</td>
      <td>55000.00</td>
      <td>35000.00</td>
      <td>41000.00</td>
      <td>98000.00</td>
      <td>42000.00</td>
      <td>47784.00</td>
      <td>35000.00</td>
      <td>69000.00</td>
      <td>75000.00</td>
      <td>49000.00</td>
      <td>120000.00</td>
      <td>42000.00</td>
      <td>63078.00</td>
      <td>48000.00</td>
      <td>54000.00</td>
      <td>27000.00</td>
      <td>50000.00</td>
      <td>32000.00</td>
    </tr>
    <tr>
      <th>verification_status</th>
      <td>Source Verified</td>
      <td>Verified</td>
      <td>Source Verified</td>
      <td>Verified</td>
      <td>Not Verified</td>
      <td>Verified</td>
      <td>Not Verified</td>
      <td>Source Verified</td>
      <td>Verified</td>
      <td>Not Verified</td>
      <td>Verified</td>
      <td>Source Verified</td>
      <td>Source Verified</td>
      <td>Not Verified</td>
      <td>Verified</td>
      <td>Not Verified</td>
      <td>Not Verified</td>
      <td>Verified</td>
      <td>Source Verified</td>
      <td>Not Verified</td>
      <td>Source Verified</td>
      <td>Verified</td>
      <td>Not Verified</td>
      <td>Source Verified</td>
      <td>Not Verified</td>
      <td>Not Verified</td>
      <td>Source Verified</td>
      <td>Verified</td>
      <td>Not Verified</td>
      <td>Not Verified</td>
      <td>Source Verified</td>
      <td>Not Verified</td>
      <td>Verified</td>
      <td>Not Verified</td>
      <td>Not Verified</td>
      <td>Verified</td>
      <td>Not Verified</td>
      <td>...</td>
      <td>Verified</td>
      <td>Not Verified</td>
      <td>Source Verified</td>
      <td>Verified</td>
      <td>Source Verified</td>
      <td>Not Verified</td>
      <td>Not Verified</td>
      <td>Verified</td>
      <td>Source Verified</td>
      <td>Not Verified</td>
      <td>Source Verified</td>
      <td>Verified</td>
      <td>Source Verified</td>
      <td>Not Verified</td>
      <td>Verified</td>
      <td>Source Verified</td>
      <td>Verified</td>
      <td>Source Verified</td>
      <td>Source Verified</td>
      <td>Verified</td>
      <td>Verified</td>
      <td>Verified</td>
      <td>Verified</td>
      <td>Verified</td>
      <td>Verified</td>
      <td>Verified</td>
      <td>Verified</td>
      <td>Verified</td>
      <td>Verified</td>
      <td>Verified</td>
      <td>Verified</td>
      <td>Source Verified</td>
      <td>Verified</td>
      <td>Not Verified</td>
      <td>Source Verified</td>
      <td>Verified</td>
      <td>Verified</td>
    </tr>
    <tr>
      <th>dti</th>
      <td>16.94</td>
      <td>24.68</td>
      <td>18.55</td>
      <td>22.18</td>
      <td>15.75</td>
      <td>27.06</td>
      <td>6.15</td>
      <td>2.49</td>
      <td>16.73</td>
      <td>25.79</td>
      <td>19.20</td>
      <td>16.70</td>
      <td>27.03</td>
      <td>8.91</td>
      <td>8.07</td>
      <td>7.39</td>
      <td>7.37</td>
      <td>13.56</td>
      <td>17.61</td>
      <td>25.14</td>
      <td>19.80</td>
      <td>10.83</td>
      <td>18.84</td>
      <td>28.25</td>
      <td>20.02</td>
      <td>3.68</td>
      <td>9.56</td>
      <td>25.92</td>
      <td>15.85</td>
      <td>14.76</td>
      <td>19.62</td>
      <td>21.54</td>
      <td>5.98</td>
      <td>17.95</td>
      <td>9.82</td>
      <td>21.45</td>
      <td>8.04</td>
      <td>...</td>
      <td>15.95</td>
      <td>31.44</td>
      <td>31.53</td>
      <td>23.65</td>
      <td>20.70</td>
      <td>9.82</td>
      <td>9.51</td>
      <td>16.54</td>
      <td>8.49</td>
      <td>9.03</td>
      <td>18.62</td>
      <td>26.58</td>
      <td>10.10</td>
      <td>22.25</td>
      <td>28.85</td>
      <td>9.86</td>
      <td>12.83</td>
      <td>23.74</td>
      <td>10.88</td>
      <td>31.22</td>
      <td>18.93</td>
      <td>26.70</td>
      <td>15.56</td>
      <td>26.74</td>
      <td>14.69</td>
      <td>8.30</td>
      <td>8.23</td>
      <td>23.35</td>
      <td>22.58</td>
      <td>26.60</td>
      <td>10.66</td>
      <td>31.70</td>
      <td>36.93</td>
      <td>13.22</td>
      <td>18.58</td>
      <td>12.63</td>
      <td>29.44</td>
    </tr>
    <tr>
      <th>delinq_2yrs</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>2.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>4.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>2.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>inq_last_6mths</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>2.00</td>
      <td>2.00</td>
      <td>2.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>2.00</td>
      <td>2.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>2.00</td>
      <td>0.00</td>
      <td>4.00</td>
      <td>4.00</td>
      <td>2.00</td>
      <td>1.00</td>
      <td>2.00</td>
      <td>0.00</td>
      <td>3.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>2.00</td>
      <td>1.00</td>
      <td>...</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>2.00</td>
      <td>2.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>2.00</td>
      <td>1.00</td>
      <td>2.00</td>
      <td>2.00</td>
      <td>0.00</td>
      <td>2.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>3.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>2.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>mths_since_last_delinq</th>
      <td>53.00</td>
      <td>58.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>64.00</td>
      <td>300.00</td>
      <td>59.00</td>
      <td>8.00</td>
      <td>63.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>30.00</td>
      <td>11.00</td>
      <td>17.00</td>
      <td>20.00</td>
      <td>37.00</td>
      <td>24.00</td>
      <td>7.00</td>
      <td>300.00</td>
      <td>36.00</td>
      <td>300.00</td>
      <td>...</td>
      <td>300.00</td>
      <td>5.00</td>
      <td>16.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>62.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>41.00</td>
      <td>20.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>10.00</td>
      <td>6.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>29.00</td>
      <td>11.00</td>
      <td>11.00</td>
      <td>28.00</td>
      <td>73.00</td>
      <td>300.00</td>
      <td>6.00</td>
      <td>69.00</td>
      <td>45.00</td>
      <td>300.00</td>
      <td>38.00</td>
      <td>16.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>65.00</td>
    </tr>
    <tr>
      <th>mths_since_last_record</th>
      <td>33.00</td>
      <td>53.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>104.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>98.00</td>
      <td>59.00</td>
      <td>80.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>63.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>98.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>104.00</td>
      <td>72.00</td>
      <td>300.00</td>
      <td>...</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>65.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>119.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>44.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>84.00</td>
      <td>300.00</td>
    </tr>
    <tr>
      <th>open_acc</th>
      <td>7.00</td>
      <td>5.00</td>
      <td>15.00</td>
      <td>14.00</td>
      <td>9.00</td>
      <td>12.00</td>
      <td>16.00</td>
      <td>3.00</td>
      <td>29.00</td>
      <td>10.00</td>
      <td>14.00</td>
      <td>10.00</td>
      <td>13.00</td>
      <td>9.00</td>
      <td>7.00</td>
      <td>12.00</td>
      <td>12.00</td>
      <td>17.00</td>
      <td>7.00</td>
      <td>20.00</td>
      <td>11.00</td>
      <td>10.00</td>
      <td>9.00</td>
      <td>13.00</td>
      <td>14.00</td>
      <td>4.00</td>
      <td>27.00</td>
      <td>20.00</td>
      <td>12.00</td>
      <td>11.00</td>
      <td>13.00</td>
      <td>13.00</td>
      <td>6.00</td>
      <td>25.00</td>
      <td>13.00</td>
      <td>30.00</td>
      <td>11.00</td>
      <td>...</td>
      <td>7.00</td>
      <td>14.00</td>
      <td>11.00</td>
      <td>10.00</td>
      <td>11.00</td>
      <td>13.00</td>
      <td>12.00</td>
      <td>15.00</td>
      <td>14.00</td>
      <td>8.00</td>
      <td>29.00</td>
      <td>23.00</td>
      <td>14.00</td>
      <td>8.00</td>
      <td>11.00</td>
      <td>23.00</td>
      <td>10.00</td>
      <td>17.00</td>
      <td>10.00</td>
      <td>13.00</td>
      <td>10.00</td>
      <td>10.00</td>
      <td>31.00</td>
      <td>7.00</td>
      <td>10.00</td>
      <td>6.00</td>
      <td>9.00</td>
      <td>13.00</td>
      <td>22.00</td>
      <td>17.00</td>
      <td>18.00</td>
      <td>8.00</td>
      <td>13.00</td>
      <td>9.00</td>
      <td>3.00</td>
      <td>11.00</td>
      <td>9.00</td>
    </tr>
    <tr>
      <th>revol_bal</th>
      <td>5572.00</td>
      <td>2875.00</td>
      <td>29581.00</td>
      <td>21617.00</td>
      <td>7203.00</td>
      <td>9996.00</td>
      <td>5749.00</td>
      <td>4136.00</td>
      <td>23473.00</td>
      <td>12409.00</td>
      <td>3479.00</td>
      <td>12948.00</td>
      <td>5394.00</td>
      <td>7687.00</td>
      <td>10249.00</td>
      <td>6868.00</td>
      <td>7037.00</td>
      <td>8983.00</td>
      <td>9125.00</td>
      <td>27233.00</td>
      <td>36862.00</td>
      <td>15251.00</td>
      <td>7457.00</td>
      <td>7868.00</td>
      <td>7622.00</td>
      <td>7478.00</td>
      <td>13891.00</td>
      <td>10261.00</td>
      <td>17980.00</td>
      <td>12484.00</td>
      <td>4744.00</td>
      <td>10718.00</td>
      <td>23060.00</td>
      <td>4036.00</td>
      <td>11677.00</td>
      <td>11317.00</td>
      <td>12145.00</td>
      <td>...</td>
      <td>3113.00</td>
      <td>14249.00</td>
      <td>3484.00</td>
      <td>56172.00</td>
      <td>13596.00</td>
      <td>21798.00</td>
      <td>13917.00</td>
      <td>30246.00</td>
      <td>12987.00</td>
      <td>11878.00</td>
      <td>14722.00</td>
      <td>8835.00</td>
      <td>18671.00</td>
      <td>5432.00</td>
      <td>42256.00</td>
      <td>66441.00</td>
      <td>10868.00</td>
      <td>16190.00</td>
      <td>25630.00</td>
      <td>22438.00</td>
      <td>2796.00</td>
      <td>7594.00</td>
      <td>26590.00</td>
      <td>1294.00</td>
      <td>1963.00</td>
      <td>4317.00</td>
      <td>7755.00</td>
      <td>31794.00</td>
      <td>141120.00</td>
      <td>39234.00</td>
      <td>4419.00</td>
      <td>11063.00</td>
      <td>12943.00</td>
      <td>10776.00</td>
      <td>1756.00</td>
      <td>1700.00</td>
      <td>6987.00</td>
    </tr>
    <tr>
      <th>revol_util</th>
      <td>68.80</td>
      <td>54.20</td>
      <td>54.60</td>
      <td>76.70</td>
      <td>34.60</td>
      <td>70.90</td>
      <td>22.30</td>
      <td>16.10</td>
      <td>54.50</td>
      <td>65.00</td>
      <td>35.50</td>
      <td>45.00</td>
      <td>46.90</td>
      <td>30.30</td>
      <td>22.00</td>
      <td>10.30</td>
      <td>40.90</td>
      <td>59.90</td>
      <td>83.70</td>
      <td>64.20</td>
      <td>78.60</td>
      <td>56.10</td>
      <td>88.80</td>
      <td>19.60</td>
      <td>10.80</td>
      <td>61.30</td>
      <td>73.90</td>
      <td>13.90</td>
      <td>34.80</td>
      <td>83.20</td>
      <td>40.20</td>
      <td>57.00</td>
      <td>93.40</td>
      <td>29.70</td>
      <td>31.60</td>
      <td>30.40</td>
      <td>18.00</td>
      <td>...</td>
      <td>21.20</td>
      <td>75.80</td>
      <td>65.70</td>
      <td>68.80</td>
      <td>61.00</td>
      <td>59.90</td>
      <td>19.90</td>
      <td>70.20</td>
      <td>44.60</td>
      <td>70.70</td>
      <td>47.00</td>
      <td>29.70</td>
      <td>61.20</td>
      <td>45.60</td>
      <td>65.00</td>
      <td>55.10</td>
      <td>59.70</td>
      <td>35.90</td>
      <td>56.50</td>
      <td>63.20</td>
      <td>27.10</td>
      <td>61.70</td>
      <td>85.00</td>
      <td>34.10</td>
      <td>33.80</td>
      <td>60.20</td>
      <td>64.10</td>
      <td>81.50</td>
      <td>26.70</td>
      <td>90.50</td>
      <td>10.20</td>
      <td>54.00</td>
      <td>63.40</td>
      <td>25.80</td>
      <td>97.60</td>
      <td>5.60</td>
      <td>41.60</td>
    </tr>
    <tr>
      <th>total_acc</th>
      <td>32.00</td>
      <td>26.00</td>
      <td>31.00</td>
      <td>39.00</td>
      <td>16.00</td>
      <td>17.00</td>
      <td>16.00</td>
      <td>8.00</td>
      <td>41.00</td>
      <td>16.00</td>
      <td>49.00</td>
      <td>26.00</td>
      <td>22.00</td>
      <td>14.00</td>
      <td>19.00</td>
      <td>19.00</td>
      <td>26.00</td>
      <td>20.00</td>
      <td>32.00</td>
      <td>37.00</td>
      <td>26.00</td>
      <td>41.00</td>
      <td>14.00</td>
      <td>33.00</td>
      <td>31.00</td>
      <td>12.00</td>
      <td>43.00</td>
      <td>52.00</td>
      <td>36.00</td>
      <td>31.00</td>
      <td>38.00</td>
      <td>38.00</td>
      <td>18.00</td>
      <td>48.00</td>
      <td>29.00</td>
      <td>60.00</td>
      <td>20.00</td>
      <td>...</td>
      <td>25.00</td>
      <td>34.00</td>
      <td>21.00</td>
      <td>18.00</td>
      <td>16.00</td>
      <td>24.00</td>
      <td>14.00</td>
      <td>45.00</td>
      <td>25.00</td>
      <td>24.00</td>
      <td>42.00</td>
      <td>45.00</td>
      <td>20.00</td>
      <td>12.00</td>
      <td>23.00</td>
      <td>61.00</td>
      <td>36.00</td>
      <td>26.00</td>
      <td>15.00</td>
      <td>18.00</td>
      <td>22.00</td>
      <td>28.00</td>
      <td>64.00</td>
      <td>21.00</td>
      <td>18.00</td>
      <td>12.00</td>
      <td>15.00</td>
      <td>25.00</td>
      <td>48.00</td>
      <td>37.00</td>
      <td>50.00</td>
      <td>28.00</td>
      <td>45.00</td>
      <td>21.00</td>
      <td>4.00</td>
      <td>30.00</td>
      <td>20.00</td>
    </tr>
    <tr>
      <th>collections_12_mths_ex_med</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>mths_since_last_major_derog</th>
      <td>53.00</td>
      <td>69.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>71.00</td>
      <td>300.00</td>
      <td>59.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>62.00</td>
      <td>39.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>70.00</td>
      <td>300.00</td>
      <td>...</td>
      <td>300.00</td>
      <td>12.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>62.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>41.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>37.00</td>
      <td>6.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>29.00</td>
      <td>11.00</td>
      <td>29.00</td>
      <td>31.00</td>
      <td>75.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>69.00</td>
      <td>45.00</td>
      <td>300.00</td>
      <td>38.00</td>
      <td>28.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
    </tr>
    <tr>
      <th>acc_now_delinq</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>tot_coll_amt</th>
      <td>15386.00</td>
      <td>154.00</td>
      <td>0.00</td>
      <td>539.00</td>
      <td>0.00</td>
      <td>92.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>126.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>4009.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>2140.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>972.00</td>
    </tr>
    <tr>
      <th>tot_cur_bal</th>
      <td>13605.00</td>
      <td>19530.00</td>
      <td>799592.00</td>
      <td>199834.00</td>
      <td>15949.00</td>
      <td>24724.00</td>
      <td>13038.00</td>
      <td>4136.00</td>
      <td>23473.00</td>
      <td>50865.00</td>
      <td>45598.00</td>
      <td>16852.00</td>
      <td>24419.00</td>
      <td>115313.00</td>
      <td>70560.00</td>
      <td>369614.00</td>
      <td>48236.00</td>
      <td>66129.00</td>
      <td>252254.00</td>
      <td>215466.00</td>
      <td>221972.00</td>
      <td>168357.00</td>
      <td>36678.00</td>
      <td>47765.00</td>
      <td>29848.00</td>
      <td>7478.00</td>
      <td>80966.00</td>
      <td>222056.00</td>
      <td>222639.00</td>
      <td>303991.00</td>
      <td>161173.00</td>
      <td>84597.00</td>
      <td>42572.00</td>
      <td>421813.00</td>
      <td>76213.00</td>
      <td>80436.00</td>
      <td>485773.00</td>
      <td>...</td>
      <td>10591.00</td>
      <td>87729.00</td>
      <td>58658.00</td>
      <td>76670.00</td>
      <td>24339.00</td>
      <td>28293.00</td>
      <td>61494.00</td>
      <td>302480.00</td>
      <td>19865.00</td>
      <td>131124.00</td>
      <td>78891.00</td>
      <td>236495.00</td>
      <td>18671.00</td>
      <td>78489.00</td>
      <td>42700.00</td>
      <td>993967.00</td>
      <td>41272.00</td>
      <td>359329.00</td>
      <td>351558.00</td>
      <td>167189.00</td>
      <td>19098.00</td>
      <td>174030.00</td>
      <td>603744.00</td>
      <td>51882.00</td>
      <td>162837.00</td>
      <td>8529.00</td>
      <td>22279.00</td>
      <td>186375.00</td>
      <td>141120.00</td>
      <td>74969.00</td>
      <td>4419.00</td>
      <td>125541.00</td>
      <td>207975.00</td>
      <td>24696.00</td>
      <td>8357.00</td>
      <td>18979.00</td>
      <td>53777.00</td>
    </tr>
    <tr>
      <th>open_acc_6m</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>open_il_12m</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>open_il_24m</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>mths_since_rcnt_il</th>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>...</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
      <td>300.00</td>
    </tr>
    <tr>
      <th>total_bal_il</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>il_util</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>open_rv_12m</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>open_rv_24m</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>all_util</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>total_rev_hi_lim</th>
      <td>8100.00</td>
      <td>5300.00</td>
      <td>54200.00</td>
      <td>28200.00</td>
      <td>20800.00</td>
      <td>14100.00</td>
      <td>25800.00</td>
      <td>25700.00</td>
      <td>43100.00</td>
      <td>19100.00</td>
      <td>9800.00</td>
      <td>28800.00</td>
      <td>11500.00</td>
      <td>25400.00</td>
      <td>46600.00</td>
      <td>66800.00</td>
      <td>17200.00</td>
      <td>15000.00</td>
      <td>10900.00</td>
      <td>42400.00</td>
      <td>46900.00</td>
      <td>27200.00</td>
      <td>8400.00</td>
      <td>40100.00</td>
      <td>70900.00</td>
      <td>12200.00</td>
      <td>18800.00</td>
      <td>73900.00</td>
      <td>51600.00</td>
      <td>15000.00</td>
      <td>11800.00</td>
      <td>18800.00</td>
      <td>24700.00</td>
      <td>13600.00</td>
      <td>36900.00</td>
      <td>37200.00</td>
      <td>67300.00</td>
      <td>...</td>
      <td>14700.00</td>
      <td>18800.00</td>
      <td>5300.00</td>
      <td>81600.00</td>
      <td>22300.00</td>
      <td>36400.00</td>
      <td>70000.00</td>
      <td>43100.00</td>
      <td>29100.00</td>
      <td>16800.00</td>
      <td>31300.00</td>
      <td>29700.00</td>
      <td>30500.00</td>
      <td>11900.00</td>
      <td>65000.00</td>
      <td>120600.00</td>
      <td>18200.00</td>
      <td>38300.00</td>
      <td>45400.00</td>
      <td>35500.00</td>
      <td>10300.00</td>
      <td>12300.00</td>
      <td>31300.00</td>
      <td>3800.00</td>
      <td>5800.00</td>
      <td>7200.00</td>
      <td>12100.00</td>
      <td>39000.00</td>
      <td>233000.00</td>
      <td>43500.00</td>
      <td>43400.00</td>
      <td>20500.00</td>
      <td>20400.00</td>
      <td>41700.00</td>
      <td>1800.00</td>
      <td>30100.00</td>
      <td>16800.00</td>
    </tr>
    <tr>
      <th>inq_fi</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>total_cu_tl</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>inq_last_12m</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>pub_rec</th>
      <td>2.00</td>
      <td>2.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>2.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>max_bal_bc</th>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>...</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>loan_amnt</th>
      <td>12000.00</td>
      <td>3000.00</td>
      <td>28000.00</td>
      <td>24000.00</td>
      <td>8000.00</td>
      <td>11500.00</td>
      <td>15000.00</td>
      <td>4800.00</td>
      <td>20800.00</td>
      <td>10000.00</td>
      <td>7200.00</td>
      <td>20000.00</td>
      <td>10000.00</td>
      <td>10000.00</td>
      <td>14825.00</td>
      <td>16000.00</td>
      <td>6000.00</td>
      <td>10000.00</td>
      <td>6000.00</td>
      <td>6000.00</td>
      <td>4000.00</td>
      <td>22875.00</td>
      <td>10075.00</td>
      <td>14575.00</td>
      <td>4500.00</td>
      <td>15000.00</td>
      <td>5500.00</td>
      <td>14000.00</td>
      <td>13000.00</td>
      <td>12000.00</td>
      <td>12000.00</td>
      <td>11000.00</td>
      <td>25000.00</td>
      <td>9950.00</td>
      <td>14000.00</td>
      <td>9000.00</td>
      <td>14400.00</td>
      <td>...</td>
      <td>14075.00</td>
      <td>15000.00</td>
      <td>5000.00</td>
      <td>20000.00</td>
      <td>12000.00</td>
      <td>11200.00</td>
      <td>20000.00</td>
      <td>30000.00</td>
      <td>12000.00</td>
      <td>12825.00</td>
      <td>7675.00</td>
      <td>12000.00</td>
      <td>27650.00</td>
      <td>7200.00</td>
      <td>28500.00</td>
      <td>25000.00</td>
      <td>20000.00</td>
      <td>20000.00</td>
      <td>29675.00</td>
      <td>25000.00</td>
      <td>5875.00</td>
      <td>5875.00</td>
      <td>35000.00</td>
      <td>12000.00</td>
      <td>2725.00</td>
      <td>10000.00</td>
      <td>14000.00</td>
      <td>15000.00</td>
      <td>19600.00</td>
      <td>28000.00</td>
      <td>6000.00</td>
      <td>17000.00</td>
      <td>4200.00</td>
      <td>10775.00</td>
      <td>6225.00</td>
      <td>4000.00</td>
      <td>10850.00</td>
    </tr>
    <tr>
      <th>term</th>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>60 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>60 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>60 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>...</td>
      <td>36 months</td>
      <td>60 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>60 months</td>
      <td>60 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>60 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>60 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>60 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>60 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>60 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>60 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>60 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
      <td>36 months</td>
    </tr>
    <tr>
      <th>int_rate</th>
      <td>13.53</td>
      <td>12.85</td>
      <td>7.62</td>
      <td>13.53</td>
      <td>10.99</td>
      <td>22.90</td>
      <td>14.47</td>
      <td>10.99</td>
      <td>13.53</td>
      <td>11.99</td>
      <td>10.99</td>
      <td>13.98</td>
      <td>13.98</td>
      <td>9.67</td>
      <td>18.25</td>
      <td>7.62</td>
      <td>6.03</td>
      <td>14.98</td>
      <td>10.99</td>
      <td>9.67</td>
      <td>16.24</td>
      <td>13.98</td>
      <td>20.50</td>
      <td>13.53</td>
      <td>9.67</td>
      <td>17.57</td>
      <td>22.90</td>
      <td>8.90</td>
      <td>9.67</td>
      <td>13.98</td>
      <td>12.85</td>
      <td>7.90</td>
      <td>20.50</td>
      <td>16.24</td>
      <td>7.90</td>
      <td>14.98</td>
      <td>7.90</td>
      <td>...</td>
      <td>15.99</td>
      <td>12.39</td>
      <td>17.14</td>
      <td>14.99</td>
      <td>10.49</td>
      <td>19.99</td>
      <td>14.31</td>
      <td>14.99</td>
      <td>11.99</td>
      <td>17.14</td>
      <td>15.59</td>
      <td>12.39</td>
      <td>21.99</td>
      <td>14.99</td>
      <td>19.24</td>
      <td>12.39</td>
      <td>12.99</td>
      <td>14.99</td>
      <td>13.66</td>
      <td>20.99</td>
      <td>16.49</td>
      <td>15.59</td>
      <td>24.99</td>
      <td>17.86</td>
      <td>17.86</td>
      <td>23.99</td>
      <td>15.99</td>
      <td>12.39</td>
      <td>14.31</td>
      <td>15.59</td>
      <td>10.49</td>
      <td>15.99</td>
      <td>15.99</td>
      <td>6.03</td>
      <td>16.49</td>
      <td>8.67</td>
      <td>19.24</td>
    </tr>
    <tr>
      <th>installment</th>
      <td>407.40</td>
      <td>100.87</td>
      <td>872.52</td>
      <td>814.80</td>
      <td>261.88</td>
      <td>323.54</td>
      <td>516.10</td>
      <td>157.13</td>
      <td>706.16</td>
      <td>332.10</td>
      <td>235.69</td>
      <td>683.36</td>
      <td>232.58</td>
      <td>321.13</td>
      <td>537.83</td>
      <td>498.59</td>
      <td>182.62</td>
      <td>237.80</td>
      <td>196.41</td>
      <td>192.68</td>
      <td>141.11</td>
      <td>781.60</td>
      <td>377.00</td>
      <td>494.82</td>
      <td>144.51</td>
      <td>539.06</td>
      <td>212.62</td>
      <td>444.55</td>
      <td>417.47</td>
      <td>410.02</td>
      <td>403.47</td>
      <td>344.20</td>
      <td>935.48</td>
      <td>351.00</td>
      <td>438.07</td>
      <td>311.90</td>
      <td>450.58</td>
      <td>...</td>
      <td>494.77</td>
      <td>336.64</td>
      <td>178.62</td>
      <td>693.21</td>
      <td>257.87</td>
      <td>296.67</td>
      <td>686.57</td>
      <td>1039.82</td>
      <td>398.52</td>
      <td>458.15</td>
      <td>268.28</td>
      <td>400.82</td>
      <td>763.51</td>
      <td>249.56</td>
      <td>1048.16</td>
      <td>561.06</td>
      <td>673.79</td>
      <td>693.21</td>
      <td>685.27</td>
      <td>941.75</td>
      <td>207.98</td>
      <td>205.37</td>
      <td>1027.10</td>
      <td>432.99</td>
      <td>98.33</td>
      <td>287.63</td>
      <td>492.13</td>
      <td>501.02</td>
      <td>459.22</td>
      <td>978.74</td>
      <td>194.99</td>
      <td>413.32</td>
      <td>147.64</td>
      <td>327.95</td>
      <td>220.37</td>
      <td>126.59</td>
      <td>399.04</td>
    </tr>
    <tr>
      <th>grade</th>
      <td>B</td>
      <td>B</td>
      <td>A</td>
      <td>B</td>
      <td>B</td>
      <td>E</td>
      <td>C</td>
      <td>B</td>
      <td>B</td>
      <td>B</td>
      <td>B</td>
      <td>C</td>
      <td>C</td>
      <td>B</td>
      <td>D</td>
      <td>A</td>
      <td>A</td>
      <td>C</td>
      <td>B</td>
      <td>B</td>
      <td>C</td>
      <td>C</td>
      <td>E</td>
      <td>B</td>
      <td>B</td>
      <td>D</td>
      <td>E</td>
      <td>A</td>
      <td>B</td>
      <td>C</td>
      <td>B</td>
      <td>A</td>
      <td>E</td>
      <td>C</td>
      <td>A</td>
      <td>C</td>
      <td>A</td>
      <td>...</td>
      <td>D</td>
      <td>C</td>
      <td>D</td>
      <td>C</td>
      <td>B</td>
      <td>E</td>
      <td>C</td>
      <td>C</td>
      <td>B</td>
      <td>D</td>
      <td>D</td>
      <td>C</td>
      <td>E</td>
      <td>C</td>
      <td>E</td>
      <td>C</td>
      <td>C</td>
      <td>C</td>
      <td>C</td>
      <td>E</td>
      <td>D</td>
      <td>D</td>
      <td>F</td>
      <td>D</td>
      <td>D</td>
      <td>F</td>
      <td>D</td>
      <td>C</td>
      <td>C</td>
      <td>D</td>
      <td>B</td>
      <td>D</td>
      <td>D</td>
      <td>A</td>
      <td>D</td>
      <td>B</td>
      <td>E</td>
    </tr>
    <tr>
      <th>sub_grade</th>
      <td>B5</td>
      <td>B4</td>
      <td>A3</td>
      <td>B5</td>
      <td>B2</td>
      <td>E4</td>
      <td>C2</td>
      <td>B2</td>
      <td>B5</td>
      <td>B3</td>
      <td>B2</td>
      <td>C1</td>
      <td>C1</td>
      <td>B1</td>
      <td>D3</td>
      <td>A3</td>
      <td>A1</td>
      <td>C3</td>
      <td>B2</td>
      <td>B1</td>
      <td>C5</td>
      <td>C1</td>
      <td>E1</td>
      <td>B5</td>
      <td>B1</td>
      <td>D2</td>
      <td>E4</td>
      <td>A5</td>
      <td>B1</td>
      <td>C1</td>
      <td>B4</td>
      <td>A4</td>
      <td>E1</td>
      <td>C5</td>
      <td>A4</td>
      <td>C3</td>
      <td>A4</td>
      <td>...</td>
      <td>D2</td>
      <td>C1</td>
      <td>D4</td>
      <td>C5</td>
      <td>B3</td>
      <td>E3</td>
      <td>C4</td>
      <td>C5</td>
      <td>B5</td>
      <td>D4</td>
      <td>D1</td>
      <td>C1</td>
      <td>E5</td>
      <td>C5</td>
      <td>E2</td>
      <td>C1</td>
      <td>C2</td>
      <td>C5</td>
      <td>C3</td>
      <td>E4</td>
      <td>D3</td>
      <td>D1</td>
      <td>F4</td>
      <td>D5</td>
      <td>D5</td>
      <td>F2</td>
      <td>D2</td>
      <td>C1</td>
      <td>C4</td>
      <td>D1</td>
      <td>B3</td>
      <td>D2</td>
      <td>D2</td>
      <td>A1</td>
      <td>D3</td>
      <td>B1</td>
      <td>E2</td>
    </tr>
    <tr>
      <th>avg_defaulted_recovery</th>
      <td>0.30</td>
      <td>0.32</td>
      <td>0.35</td>
      <td>0.30</td>
      <td>0.35</td>
      <td>0.15</td>
      <td>0.26</td>
      <td>0.35</td>
      <td>0.30</td>
      <td>0.34</td>
      <td>0.35</td>
      <td>0.29</td>
      <td>0.29</td>
      <td>0.33</td>
      <td>0.22</td>
      <td>0.35</td>
      <td>0.36</td>
      <td>0.26</td>
      <td>0.35</td>
      <td>0.33</td>
      <td>0.23</td>
      <td>0.29</td>
      <td>0.17</td>
      <td>0.30</td>
      <td>0.33</td>
      <td>0.23</td>
      <td>0.15</td>
      <td>0.32</td>
      <td>0.33</td>
      <td>0.29</td>
      <td>0.32</td>
      <td>0.34</td>
      <td>0.17</td>
      <td>0.23</td>
      <td>0.34</td>
      <td>0.26</td>
      <td>0.34</td>
      <td>...</td>
      <td>0.23</td>
      <td>0.29</td>
      <td>0.21</td>
      <td>0.23</td>
      <td>0.34</td>
      <td>0.15</td>
      <td>0.24</td>
      <td>0.23</td>
      <td>0.30</td>
      <td>0.21</td>
      <td>0.24</td>
      <td>0.29</td>
      <td>0.15</td>
      <td>0.23</td>
      <td>0.17</td>
      <td>0.29</td>
      <td>0.26</td>
      <td>0.23</td>
      <td>0.26</td>
      <td>0.15</td>
      <td>0.22</td>
      <td>0.24</td>
      <td>0.12</td>
      <td>0.20</td>
      <td>0.20</td>
      <td>0.13</td>
      <td>0.23</td>
      <td>0.29</td>
      <td>0.24</td>
      <td>0.24</td>
      <td>0.34</td>
      <td>0.23</td>
      <td>0.23</td>
      <td>0.36</td>
      <td>0.22</td>
      <td>0.33</td>
      <td>0.17</td>
    </tr>
    <tr>
      <th>avg_portion_defaulted</th>
      <td>0.22</td>
      <td>0.19</td>
      <td>0.08</td>
      <td>0.22</td>
      <td>0.16</td>
      <td>0.45</td>
      <td>0.26</td>
      <td>0.16</td>
      <td>0.22</td>
      <td>0.17</td>
      <td>0.16</td>
      <td>0.24</td>
      <td>0.24</td>
      <td>0.15</td>
      <td>0.35</td>
      <td>0.08</td>
      <td>0.05</td>
      <td>0.29</td>
      <td>0.16</td>
      <td>0.15</td>
      <td>0.32</td>
      <td>0.24</td>
      <td>0.42</td>
      <td>0.22</td>
      <td>0.15</td>
      <td>0.36</td>
      <td>0.45</td>
      <td>0.13</td>
      <td>0.15</td>
      <td>0.24</td>
      <td>0.19</td>
      <td>0.10</td>
      <td>0.42</td>
      <td>0.32</td>
      <td>0.10</td>
      <td>0.29</td>
      <td>0.10</td>
      <td>...</td>
      <td>0.36</td>
      <td>0.24</td>
      <td>0.39</td>
      <td>0.32</td>
      <td>0.17</td>
      <td>0.45</td>
      <td>0.31</td>
      <td>0.32</td>
      <td>0.22</td>
      <td>0.39</td>
      <td>0.34</td>
      <td>0.24</td>
      <td>0.48</td>
      <td>0.32</td>
      <td>0.44</td>
      <td>0.24</td>
      <td>0.26</td>
      <td>0.32</td>
      <td>0.29</td>
      <td>0.45</td>
      <td>0.35</td>
      <td>0.34</td>
      <td>0.51</td>
      <td>0.40</td>
      <td>0.40</td>
      <td>0.48</td>
      <td>0.36</td>
      <td>0.24</td>
      <td>0.31</td>
      <td>0.34</td>
      <td>0.17</td>
      <td>0.36</td>
      <td>0.36</td>
      <td>0.05</td>
      <td>0.35</td>
      <td>0.15</td>
      <td>0.44</td>
    </tr>
  </tbody>
</table>
<p>41 rows Ã— 210406 columns</p>
</div></div></div>
</div>
<p>We can confirm that there is no <strong>post-originated loan data</strong> in our transformer. Using this process, we can infer the future trends (based on our knowledge in available data) without leaking unknown data, mimics the real condition of future prediction.</p>
</section>
<section id="combining-into-pipeline">
<h3><strong>Combining into Pipeline</strong><a class="headerlink" href="#combining-into-pipeline" title="Permalink to this headline">#</a></h3>
<p>Let’s recap our model pipeline up to this section:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scale_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;mths_since_last_delinq&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mths_since_last_record&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mths_since_last_major_derog&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mths_since_rcnt_il&#39;</span><span class="p">,</span>
    <span class="s1">&#39;inq_last_6mths&#39;</span><span class="p">,</span>
    <span class="s1">&#39;collections_12_mths_ex_med&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;acc_now_delinq&#39;</span><span class="p">,</span> <span class="s1">&#39;open_acc_6m&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;open_il_12m&#39;</span><span class="p">,</span> <span class="s1">&#39;open_il_24m&#39;</span><span class="p">,</span>
    <span class="s1">&#39;total_bal_il&#39;</span><span class="p">,</span> <span class="s1">&#39;il_util&#39;</span><span class="p">,</span> <span class="s1">&#39;open_rv_12m&#39;</span><span class="p">,</span> <span class="s1">&#39;open_rv_24m&#39;</span><span class="p">,</span>
    <span class="s1">&#39;all_util&#39;</span><span class="p">,</span> <span class="s1">&#39;inq_fi&#39;</span><span class="p">,</span> <span class="s1">&#39;total_cu_tl&#39;</span><span class="p">,</span> <span class="s1">&#39;inq_last_12m&#39;</span><span class="p">,</span>
    <span class="s1">&#39;max_bal_bc&#39;</span><span class="p">,</span> 
    <span class="p">]</span>
<span class="n">categorical_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;emp_length&#39;</span><span class="p">,</span> <span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;verification_status&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_grade&#39;</span><span class="p">]</span>
<span class="n">transform_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;annual_inc&#39;</span><span class="p">,</span> <span class="s1">&#39;dti&#39;</span><span class="p">,</span> <span class="s1">&#39;delinq_2yrs&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;open_acc&#39;</span><span class="p">,</span>
    <span class="s1">&#39;revol_bal&#39;</span><span class="p">,</span> <span class="s1">&#39;revol_util&#39;</span><span class="p">,</span> <span class="s1">&#39;total_acc&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tot_coll_amt&#39;</span><span class="p">,</span> <span class="s1">&#39;tot_cur_bal&#39;</span><span class="p">,</span>
    <span class="s1">&#39;total_rev_hi_lim&#39;</span><span class="p">,</span>  <span class="s1">&#39;pub_rec&#39;</span><span class="p">,</span> <span class="s1">&#39;int_rate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;installment&#39;</span><span class="p">,</span> <span class="s1">&#39;loan_amnt&#39;</span><span class="p">]</span>
<span class="n">dataset_preprocess</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocess&#39;</span><span class="p">,</span> <span class="n">LoanDataPreprocess</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;extract_label_predictor&#39;</span><span class="p">,</span> <span class="n">LoanDataLabelPredictor</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;earliest_cr_line&#39;</span><span class="p">,</span> <span class="s1">&#39;pymnt_plan&#39;</span><span class="p">,</span> <span class="s1">&#39;policy_code&#39;</span><span class="p">,</span> <span class="s1">&#39;term&#39;</span><span class="p">],</span> 
                                                       <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_rec_prncp&#39;</span><span class="p">])),</span>
    <span class="p">(</span><span class="s1">&#39;missing_handler&#39;</span><span class="p">,</span> <span class="n">LoanDataMissingHandler</span><span class="p">()),</span>
    <span class="p">])</span>
<span class="n">feature_modifier</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;categorical&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">categorical_cols</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;power&#39;</span><span class="p">,</span> <span class="n">PowerTransformer</span><span class="p">(</span><span class="n">standardize</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">transform_cols</span><span class="p">),</span>
    <span class="c1"># (&#39;discretize&#39;, RobustScaler(), scale_cols)</span>
    <span class="p">],</span> <span class="n">remainder</span><span class="o">=</span><span class="s1">&#39;passthrough&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="n">transform</span><span class="o">=</span><span class="s1">&#39;pandas&#39;</span><span class="p">)</span>
<span class="n">dataset_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;feature_extract&#39;</span><span class="p">,</span> <span class="n">LoanFeatureExtract</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;feature_modifier&#39;</span><span class="p">,</span> <span class="n">feature_modifier</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">dataset_pipeline</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>#sk-container-id-3 {color: black;background-color: white;}#sk-container-id-3 pre{padding: 0;}#sk-container-id-3 div.sk-toggleable {background-color: white;}#sk-container-id-3 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-3 label.sk-toggleable__label-arrow:before {content: "â–¸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-3 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-3 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-3 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-3 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-3 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-3 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "â–¾";}#sk-container-id-3 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-3 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-3 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-3 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-3 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-3 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-3 div.sk-item {position: relative;z-index: 1;}#sk-container-id-3 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-3 div.sk-item::before, #sk-container-id-3 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-3 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-3 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-3 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-3 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-3 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-3 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-3 div.sk-label-container {text-align: center;}#sk-container-id-3 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-3 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-3" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[(&#x27;feature_extract&#x27;, LoanFeatureExtract()),
                (&#x27;feature_modifier&#x27;,
                 ColumnTransformer(remainder=&#x27;passthrough&#x27;,
                                   transformers=[(&#x27;categorical&#x27;,
                                                  OneHotEncoder(handle_unknown=&#x27;ignore&#x27;,
                                                                sparse_output=False),
                                                  [&#x27;emp_length&#x27;,
                                                   &#x27;home_ownership&#x27;,
                                                   &#x27;verification_status&#x27;,
                                                   &#x27;grade&#x27;, &#x27;sub_grade&#x27;]),
                                                 (&#x27;power&#x27;,
                                                  PowerTransformer(standardize=False),
                                                  [&#x27;annual_inc&#x27;, &#x27;dti&#x27;,
                                                   &#x27;delinq_2yrs&#x27;, &#x27;open_acc&#x27;,
                                                   &#x27;revol_bal&#x27;, &#x27;revol_util&#x27;,
                                                   &#x27;total_acc&#x27;, &#x27;tot_coll_amt&#x27;,
                                                   &#x27;tot_cur_bal&#x27;,
                                                   &#x27;total_rev_hi_lim&#x27;,
                                                   &#x27;pub_rec&#x27;, &#x27;int_rate&#x27;,
                                                   &#x27;installment&#x27;,
                                                   &#x27;loan_amnt&#x27;])]))])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-9" type="checkbox" ><label for="sk-estimator-id-9" class="sk-toggleable__label sk-toggleable__label-arrow">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[(&#x27;feature_extract&#x27;, LoanFeatureExtract()),
                (&#x27;feature_modifier&#x27;,
                 ColumnTransformer(remainder=&#x27;passthrough&#x27;,
                                   transformers=[(&#x27;categorical&#x27;,
                                                  OneHotEncoder(handle_unknown=&#x27;ignore&#x27;,
                                                                sparse_output=False),
                                                  [&#x27;emp_length&#x27;,
                                                   &#x27;home_ownership&#x27;,
                                                   &#x27;verification_status&#x27;,
                                                   &#x27;grade&#x27;, &#x27;sub_grade&#x27;]),
                                                 (&#x27;power&#x27;,
                                                  PowerTransformer(standardize=False),
                                                  [&#x27;annual_inc&#x27;, &#x27;dti&#x27;,
                                                   &#x27;delinq_2yrs&#x27;, &#x27;open_acc&#x27;,
                                                   &#x27;revol_bal&#x27;, &#x27;revol_util&#x27;,
                                                   &#x27;total_acc&#x27;, &#x27;tot_coll_amt&#x27;,
                                                   &#x27;tot_cur_bal&#x27;,
                                                   &#x27;total_rev_hi_lim&#x27;,
                                                   &#x27;pub_rec&#x27;, &#x27;int_rate&#x27;,
                                                   &#x27;installment&#x27;,
                                                   &#x27;loan_amnt&#x27;])]))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-10" type="checkbox" ><label for="sk-estimator-id-10" class="sk-toggleable__label sk-toggleable__label-arrow">LoanFeatureExtract</label><div class="sk-toggleable__content"><pre>LoanFeatureExtract()</pre></div></div></div><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-11" type="checkbox" ><label for="sk-estimator-id-11" class="sk-toggleable__label sk-toggleable__label-arrow">feature_modifier: ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(remainder=&#x27;passthrough&#x27;,
                  transformers=[(&#x27;categorical&#x27;,
                                 OneHotEncoder(handle_unknown=&#x27;ignore&#x27;,
                                               sparse_output=False),
                                 [&#x27;emp_length&#x27;, &#x27;home_ownership&#x27;,
                                  &#x27;verification_status&#x27;, &#x27;grade&#x27;,
                                  &#x27;sub_grade&#x27;]),
                                (&#x27;power&#x27;, PowerTransformer(standardize=False),
                                 [&#x27;annual_inc&#x27;, &#x27;dti&#x27;, &#x27;delinq_2yrs&#x27;,
                                  &#x27;open_acc&#x27;, &#x27;revol_bal&#x27;, &#x27;revol_util&#x27;,
                                  &#x27;total_acc&#x27;, &#x27;tot_coll_amt&#x27;, &#x27;tot_cur_bal&#x27;,
                                  &#x27;total_rev_hi_lim&#x27;, &#x27;pub_rec&#x27;, &#x27;int_rate&#x27;,
                                  &#x27;installment&#x27;, &#x27;loan_amnt&#x27;])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-12" type="checkbox" ><label for="sk-estimator-id-12" class="sk-toggleable__label sk-toggleable__label-arrow">categorical</label><div class="sk-toggleable__content"><pre>[&#x27;emp_length&#x27;, &#x27;home_ownership&#x27;, &#x27;verification_status&#x27;, &#x27;grade&#x27;, &#x27;sub_grade&#x27;]</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-13" type="checkbox" ><label for="sk-estimator-id-13" class="sk-toggleable__label sk-toggleable__label-arrow">OneHotEncoder</label><div class="sk-toggleable__content"><pre>OneHotEncoder(handle_unknown=&#x27;ignore&#x27;, sparse_output=False)</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-14" type="checkbox" ><label for="sk-estimator-id-14" class="sk-toggleable__label sk-toggleable__label-arrow">power</label><div class="sk-toggleable__content"><pre>[&#x27;annual_inc&#x27;, &#x27;dti&#x27;, &#x27;delinq_2yrs&#x27;, &#x27;open_acc&#x27;, &#x27;revol_bal&#x27;, &#x27;revol_util&#x27;, &#x27;total_acc&#x27;, &#x27;tot_coll_amt&#x27;, &#x27;tot_cur_bal&#x27;, &#x27;total_rev_hi_lim&#x27;, &#x27;pub_rec&#x27;, &#x27;int_rate&#x27;, &#x27;installment&#x27;, &#x27;loan_amnt&#x27;]</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-15" type="checkbox" ><label for="sk-estimator-id-15" class="sk-toggleable__label sk-toggleable__label-arrow">PowerTransformer</label><div class="sk-toggleable__content"><pre>PowerTransformer(standardize=False)</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-16" type="checkbox" ><label for="sk-estimator-id-16" class="sk-toggleable__label sk-toggleable__label-arrow">remainder</label><div class="sk-toggleable__content"><pre></pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-17" type="checkbox" ><label for="sk-estimator-id-17" class="sk-toggleable__label sk-toggleable__label-arrow">passthrough</label><div class="sk-toggleable__content"><pre>passthrough</pre></div></div></div></div></div></div></div></div></div></div></div></div></div></div>
</div>
<p>Now let’s try our XGBoost model for any performance improvement.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># prepare the dataset</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">dataset_preprocess</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_set</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">dataset_preprocess</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_set</span><span class="p">)</span>
<span class="n">X_train_transfd</span> <span class="o">=</span> <span class="n">dataset_pipeline</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">X_test_transfd</span> <span class="o">=</span> <span class="n">dataset_pipeline</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">map_array</span><span class="p">)(</span><span class="n">y_train</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">map_array</span><span class="p">)(</span><span class="n">y_test</span><span class="p">)</span>
<span class="c1"># prepare model</span>
<span class="n">xgb_clf</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="p">)</span>
<span class="c1"># initialize an empty list to store the scores</span>
<span class="n">scoring_method</span> <span class="o">=</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">needs_proba</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># returns callable in form of scorer(estimator, X, y)</span>
<span class="n">cross_val_evaluation</span><span class="p">([</span><span class="n">xgb_clf</span><span class="p">],</span> <span class="n">X_train_transfd</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">scoring_method</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [09:15&lt;00:00, 555.28s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>XGBClassifier: Mean score = 0.71, Standard deviation = 0.00
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<p>Let’s check feature importance and identify if any of our extracted feature is importance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xgb_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_transfd</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">plot_importance</span><span class="p">(</span><span class="n">xgb_clf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/processed_54_0.png" src="../_images/processed_54_0.png" />
</div>
</div>
<p>It may be possible to perform a regression problem of <code class="docutils literal notranslate"><span class="pre">total_loan_recovery</span></code> and serve the regression results as a new predictor. This kind of imputation is expensive therefore not implemented in this analysis.</p>
<p><a id="6-hyperparameter"> </a></p>
</section>
</section>
<section id="hyperparameter-optimization">
<h2>6. Hyperparameter Optimization<a class="headerlink" href="#hyperparameter-optimization" title="Permalink to this headline">#</a></h2>
<p>Let’s first inspect how our boosting performs at each step to get a general idea of hyperparameter optimization strategy!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_xgb_learning_step</span><span class="p">(</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> 
        <span class="n">num_rounds</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
    <span class="c1"># boost element</span>
    <span class="n">boost</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># classifier</span>
    <span class="n">xgb</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="c1"># iteration records</span>
    <span class="n">boost_step_no</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">auc_train</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">auc_val</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># iterate for each step</span>
    <span class="k">def</span> <span class="nf">boost_step</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">xgb</span><span class="p">,</span> <span class="n">boost</span><span class="p">,</span> <span class="n">boost_step_no</span><span class="p">,</span> <span class="n">auc_train</span><span class="p">,</span> <span class="n">auc_val</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span>
        <span class="k">if</span> <span class="n">steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">boost</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span> <span class="c1"># first step must be fitted</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">boost</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">xgb_model</span><span class="o">=</span><span class="n">boost</span><span class="p">)</span> <span class="c1"># use fitted boost step</span>
        <span class="n">y_train_proba</span> <span class="o">=</span> <span class="n">boost</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">y_valid_proba</span> <span class="o">=</span> <span class="n">boost</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">auc_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_proba</span><span class="p">))</span>
        <span class="n">auc_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_proba</span><span class="p">))</span> 
        <span class="n">boost_step_no</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>   
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rounds</span><span class="p">):</span>
        <span class="n">boost_step</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c1">#plot</span>
    <span class="n">plot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">boost_step_no</span><span class="p">,</span> <span class="n">auc_train</span><span class="p">,</span> <span class="n">auc_val</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;validation&#39;</span><span class="p">])</span>
    <span class="n">plot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">plot_df</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">],</span> <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;validation&#39;</span><span class="p">],</span>
        <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;AUC&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">plot_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;AUC&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">boost</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> Learning Steps,</span><span class="se">\n</span><span class="s1">Parameters = </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
<span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> 
    <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> 
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="p">}</span>
<span class="n">plot_xgb_learning_step</span><span class="p">(</span>
    <span class="n">X_train_transfd</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_transfd</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
    <span class="n">num_rounds</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">model_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/processed_58_0.png" src="../_images/processed_58_0.png" />
</div>
</div>
<p>We can see the point that our model start overfitting the train set. We will implement <code class="docutils literal notranslate"><span class="pre">Early</span> <span class="pre">Stopping</span> <span class="pre">Callbacks</span></code> to get the where is the best round numbers of learning.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xgb_clf</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;auc&#39;</span><span class="p">,</span> <span class="c1"># these are the callback parameter</span>
    <span class="p">)</span>
<span class="n">xgb_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train_transfd</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
    <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_test_transfd</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;XGBoostClassifier best scores (AUC, validation set): </span><span class="si">{</span><span class="n">xgb_clf</span><span class="o">.</span><span class="n">best_score</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> at </span><span class="si">{</span><span class="n">xgb_clf</span><span class="o">.</span><span class="n">best_iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>XGBoostClassifier best scores (AUC, validation set): 0.698 at 38 iterations
</pre></div>
</div>
</div>
</div>
<p>We can observe that the model converges rather fast, indicates that the learning rate may be too high hence consider to try lower learning rate.</p>
<blockquote>
<div><p>About <em>EarlyStopping</em> Callback</p>
<p>Above code implements early stopping by defining <code class="docutils literal notranslate"><span class="pre">early_stopping_rounds</span></code> and <code class="docutils literal notranslate"><span class="pre">eval_metric</span></code> instantiation parameters, followed by <code class="docutils literal notranslate"><span class="pre">eval_set</span></code> in <code class="docutils literal notranslate"><span class="pre">fit</span></code> method. The most appropriate approach is to use a <code class="docutils literal notranslate"><span class="pre">validation</span> <span class="pre">set</span></code> independent of <code class="docutils literal notranslate"><span class="pre">test</span> <span class="pre">set</span></code>.</p>
<p>Furthermore, we can create a more flexible callback specification (for example: setting up the tolerance, return best model, etc.) by constructing <code class="docutils literal notranslate"><span class="pre">xgb.callback.EarlyStopping</span></code> object and pass it to the constructor. However, this is not needed in our case since we will wrap it into <code class="docutils literal notranslate"><span class="pre">Optuna</span></code> hyperparams optimization and the default callback params value is already appropriate.</p>
</div></blockquote>
<section id="initial-hyperparameter-optimization">
<h3><strong>Initial Hyperparameter Optimization</strong><a class="headerlink" href="#initial-hyperparameter-optimization" title="Permalink to this headline">#</a></h3>
<p>Here I determine the hyperparameters to be optimized using <code class="docutils literal notranslate"><span class="pre">Optuna</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">optuna</span> 
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># learning parameter</span>
        <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="c1"># if xgb.best_iter = 200 means that don&#39;t converge to minima yet</span>
        <span class="s1">&#39;early_stopping_rounds&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="c1"># wait until 30 iterations</span>
        <span class="s1">&#39;eval_metric&#39;</span><span class="p">:</span> <span class="s1">&#39;auc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;subsample&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;max_delta_step&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;max_delta_step&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="s1">&#39;scale_pos_weight&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;scale_post_weight&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="c1"># intended to balance positive instance. </span>
                                                                            <span class="c1"># remember that our training set proportion </span>
                                                                            <span class="c1"># is 75% [0] - 25% [1]</span>
        <span class="c1"># tree complexity</span>
        <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;max_depth&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="c1"># [1, 4]</span>
        <span class="s1">&#39;min_child_weight&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;minimal_child_weight&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="c1"># shrinkage</span>
        <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="c1"># shrinkage</span>
        <span class="p">}</span>
    <span class="n">xgb_clf</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="n">xgb_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">X_train_transfd</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
        <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_test_transfd</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="n">xgb_clf</span><span class="o">.</span><span class="n">best_score</span>
    <span class="n">best_iteration</span> <span class="o">=</span> <span class="n">xgb_clf</span><span class="o">.</span><span class="n">best_iteration</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;XGBoostClassifier, trial </span><span class="si">{</span><span class="n">trial</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s1"> best scores (AUC, validation set): &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> at </span><span class="si">{</span><span class="n">best_iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span> <span class="c1"># using this logging, we can identify if `num_of_iterations`</span>
                                                            <span class="c1"># is not enough for the `learning_rate` at specific trial</span>
    <span class="k">return</span> <span class="n">best_score</span>

<span class="c1"># setting up logging specification</span>
<span class="n">current_date_time_</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H-%M&#39;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;models/xgb_opt_log_</span><span class="si">{</span><span class="n">current_date_time_</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> 
    <span class="p">)</span>
<span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<span class="c1"># setting up optuna</span>
<span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span>
    <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;maximize&#39;</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">optuna</span><span class="o">.</span><span class="n">samplers</span><span class="o">.</span><span class="n">TPESampler</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
    <span class="p">)</span>
<span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="c1"># close logging file</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for model persistence</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">optuna</span>

<span class="c1"># serialize</span>
<span class="c1"># with open(&#39;models/initial_study.pkl&#39;, &#39;wb&#39;) as f:</span>
<span class="c1">#     pickle.dump(study, f)</span>
<span class="c1"># with open(&#39;models/initial_sampler.pkl&#39;, &#39;wb&#39;) as f:</span>
<span class="c1">#     pickle.dump(study.sampler, f)</span>
<span class="c1"># import serialized study</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;models\initial_sampler.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
<span class="n">study</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;models\initial_study.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>What have we done in above codes?</p>
<ol class="simple">
<li><p>Optuna performs the optimization using <code class="docutils literal notranslate"><span class="pre">func</span></code> that returns the objective to be maximized. From previous section, we already know how to get the best score by utilizing XGBClassifier <code class="docutils literal notranslate"><span class="pre">early_stopping</span></code> callback. We set the <code class="docutils literal notranslate"><span class="pre">.best_score</span></code> attribute as the objective and set the study’s <code class="docutils literal notranslate"><span class="pre">direction</span></code> to <code class="docutils literal notranslate"><span class="pre">maximize</span></code>.</p></li>
<li><p>We set possible hyperparams to be optimized inside the <code class="docutils literal notranslate"><span class="pre">objective</span></code> func. Since the params are rather too many, we can identify which one is significance to be adjusted by inspecting the <code class="docutils literal notranslate"><span class="pre">importance</span></code> of each hyperparams and perform re-optimization with selected params and narrowed range (<em>zooming in</em>) if deemed necessary.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logging</span></code> provides a better inspection for each of the iteration. Notice on how I limit <code class="docutils literal notranslate"><span class="pre">num_of_rounds</span></code> to <code class="docutils literal notranslate"><span class="pre">200</span></code> (to minimize computation cost). On smaller learning rate, the model may not converged yet and we can identify it by inspecting the <span class="xref myst">log file</span>. If the iterations valued at around <code class="docutils literal notranslate"><span class="pre">200</span></code>, this will shows <code class="docutils literal notranslate"><span class="pre">num_of_rounds</span></code> is too small and <code class="docutils literal notranslate"><span class="pre">AUC</span></code> may be improved for larger <code class="docutils literal notranslate"><span class="pre">num_of_rounds</span></code>.</p></li>
<li><p>We choose <code class="docutils literal notranslate"><span class="pre">TPE</span></code> as the sampling algorithm since it performance is known to be robust for small iterations. Number of <code class="docutils literal notranslate"><span class="pre">n_trials</span> <span class="pre">=</span> <span class="pre">100</span></code> is the minimum recommended sample size (refer to Optuna documentaries). We use <code class="docutils literal notranslate"><span class="pre">LogUniform</span></code> distribution focusing on exponentially sampling (e.g. <code class="docutils literal notranslate"><span class="pre">0.1</span></code>, <code class="docutils literal notranslate"><span class="pre">0.01</span></code>, <code class="docutils literal notranslate"><span class="pre">0.001</span></code>). For large range hyperparameter space, we will analyze the <em>parallel coordinate plot</em> to identify possible best narrower range, and will consider for <em>zooming in</em> optimization.</p></li>
</ol>
<p>Let’s see the best results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_df_from_study</span><span class="p">(</span><span class="n">study_</span><span class="p">,</span> <span class="n">log_file_dir</span><span class="p">):</span>
    <span class="c1"># reading log files</span>
    <span class="n">xgb_log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file_dir</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">xgb_log_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">xgb_log</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">])</span>
    <span class="n">xgb_iters</span> <span class="o">=</span> <span class="n">xgb_log_df</span>\
        <span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">14</span><span class="p">]]</span>\
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="mi">14</span><span class="p">:</span> <span class="s1">&#39;xgb_iters&#39;</span><span class="p">})</span>\
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">number</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">),</span>
            <span class="n">xgb_iters</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">xgb_iters</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">))</span>
    <span class="c1"># export study results to DataFrame</span>
    <span class="n">study_results_df</span> <span class="o">=</span> <span class="n">study_</span><span class="o">.</span><span class="n">trials_dataframe</span><span class="p">()</span>
    <span class="c1"># study_results_df = study_results_df.dropna().assign(</span>
    <span class="c1">#     xgb_iters=xgb_iters.astype(&#39;int64&#39;)</span>
    <span class="c1">#     )</span>
    <span class="n">study_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">study_results_df</span><span class="p">,</span> <span class="n">xgb_iters</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;number&#39;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">study_results_df</span>

<span class="c1"># reading log files</span>
<span class="n">study_results</span> <span class="o">=</span> <span class="n">create_df_from_study</span><span class="p">(</span><span class="n">study</span><span class="p">,</span> <span class="s1">&#39;models</span><span class="se">\\</span><span class="s1">xgb_opt_log_2023-01-26_10-58.log&#39;</span><span class="p">)</span>
<span class="n">study_results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>11</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>number</th>
      <td>11</td>
    </tr>
    <tr>
      <th>value</th>
      <td>0.70</td>
    </tr>
    <tr>
      <th>datetime_start</th>
      <td>2023-01-26 12:39:36.501800</td>
    </tr>
    <tr>
      <th>datetime_complete</th>
      <td>2023-01-26 12:41:46.919822</td>
    </tr>
    <tr>
      <th>duration</th>
      <td>0 days 00:02:10.418022</td>
    </tr>
    <tr>
      <th>params_alpha</th>
      <td>5.39</td>
    </tr>
    <tr>
      <th>params_gamma</th>
      <td>3.31</td>
    </tr>
    <tr>
      <th>params_learning_rate</th>
      <td>0.09</td>
    </tr>
    <tr>
      <th>params_max_delta_step</th>
      <td>7.63</td>
    </tr>
    <tr>
      <th>params_max_depth</th>
      <td>3</td>
    </tr>
    <tr>
      <th>params_minimal_child_weight</th>
      <td>4.39</td>
    </tr>
    <tr>
      <th>params_scale_post_weight</th>
      <td>1.81</td>
    </tr>
    <tr>
      <th>params_subsample</th>
      <td>0.72</td>
    </tr>
    <tr>
      <th>state</th>
      <td>COMPLETE</td>
    </tr>
    <tr>
      <th>xgb_iters</th>
      <td>193</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="analyzing-optimization-results">
<h3><strong>Analyzing Optimization Results</strong><a class="headerlink" href="#analyzing-optimization-results" title="Permalink to this headline">#</a></h3>
<p>Let’s first analyze score growth during each trials:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">max_point</span> <span class="o">=</span> <span class="n">study_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">study_results</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">study_results</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">study_results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">study_results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;xgb_iters&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">max_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">max_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">yticks</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">max_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="p">[</span><span class="n">max_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trial Number&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score (AUC)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Optimization Score Growth&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trial Number&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;XGB Iterations&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Number of XGB Iterations&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Number of XGB Iterations&#39;)
</pre></div>
</div>
<img alt="../_images/processed_71_1.png" src="../_images/processed_71_1.png" />
</div>
</div>
<p>Looks like our optimizer is by XGB iteration limits of 200. Perhaps we shall increase our XGB iterations limit. Indeed it will increase the computation cost.</p>
<p>Let’s look at parameter importance:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">optuna</span>

<span class="n">param_importances</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">importance</span><span class="o">.</span><span class="n">get_param_importances</span><span class="p">(</span><span class="n">study</span><span class="p">)</span>
<span class="n">importance_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">param_importances</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
<span class="n">param_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">param_importances</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">importance_values</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">for</span> <span class="n">y_</span><span class="p">,</span> <span class="n">x_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">importance_values</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">x_</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">),</span> 
        <span class="n">y</span><span class="o">=</span><span class="n">y_</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_</span><span class="si">:</span><span class="s1">,.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span>
        <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Hyperparameter Importances&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Hyperparameter Importances&#39;)
</pre></div>
</div>
<img alt="../_images/processed_73_1.png" src="../_images/processed_73_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">optuna.visualization</span> <span class="kn">import</span> <span class="n">plot_parallel_coordinate</span>

<span class="n">plot_parallel_coordinate</span><span class="p">(</span><span class="n">study</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/processed_74_0.png" src="../_images/processed_74_0.png" />
</div>
</div>
<p>Parallel coordinate plots, in my opinion, is one of the most informative plot for hyperparameter tuning.</p>
<ul class="simple">
<li><p>As we can see, perhaps the learning rate is capped at 0.1 which optimizer try to break through (recall we set the distribution at <code class="docutils literal notranslate"><span class="pre">[0.001,</span> <span class="pre">0.1]</span></code>)</p></li>
<li><p>Bi-modal tendencies of <code class="docutils literal notranslate"><span class="pre">max_depth</span></code>. We should consider increasing the cap</p></li>
<li><p>Optimizer seems to go lower on <code class="docutils literal notranslate"><span class="pre">minimal_child_weight</span></code></p></li>
</ul>
</section>
<section id="zooming-the-hyperparameters">
<h3><strong>Zooming the Hyperparameters</strong><a class="headerlink" href="#zooming-the-hyperparameters" title="Permalink to this headline">#</a></h3>
<p>Based on previous analysis, we observed that our learning rate still needs to be adjusted and the <code class="docutils literal notranslate"><span class="pre">max_iter</span></code> is too low. Some of the parameter need to be re-optimized. So we will re-optimize the parameters as below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">optuna</span> 
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># learning parameter</span>
        <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="c1"># if xgb.best_iter = 200 means that don&#39;t converge to minima yet</span>
        <span class="s1">&#39;early_stopping_rounds&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="c1"># wait until 50 iterations</span>
        <span class="s1">&#39;eval_metric&#39;</span><span class="p">:</span> <span class="s1">&#39;auc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;subsample&#39;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
        <span class="s1">&#39;max_delta_step&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;max_delta_step&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
        <span class="s1">&#39;scale_pos_weight&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;scale_post_weight&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="c1"># intended to balance positive instance. </span>
                                                                                <span class="c1"># remember that our training set proportion </span>
                                                                                <span class="c1"># is 75% [0] - 25% [1]</span>
        <span class="c1"># tree complexity</span>
        <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;max_depth&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="c1"># [1, 4]</span>
        <span class="s1">&#39;min_child_weight&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;minimal_child_weight&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="c1"># shrinkage</span>
        <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="c1"># shrinkage</span>
        <span class="p">}</span>
    <span class="n">xgb_clf</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="n">xgb_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">X_train_transfd</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
        <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_test_transfd</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="n">xgb_clf</span><span class="o">.</span><span class="n">best_score</span>
    <span class="n">best_iteration</span> <span class="o">=</span> <span class="n">xgb_clf</span><span class="o">.</span><span class="n">best_iteration</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;XGBoostClassifier, trial </span><span class="si">{</span><span class="n">trial</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s1"> best scores (AUC, validation set): &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> at </span><span class="si">{</span><span class="n">best_iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span> <span class="c1"># using this logging, we can identify if `num_of_iterations`</span>
                                                            <span class="c1"># is not enough for the `learning_rate` at specific trial</span>
    <span class="k">return</span> <span class="n">best_score</span>

<span class="c1"># setting up logging specification</span>
<span class="n">current_date_time_</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H-%M&#39;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;models/xgb_opt_log_</span><span class="si">{</span><span class="n">current_date_time_</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> 
    <span class="p">)</span>
<span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<span class="c1"># setting up optuna</span>
<span class="n">re_study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span>
    <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;maximize&#39;</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">optuna</span><span class="o">.</span><span class="n">samplers</span><span class="o">.</span><span class="n">TPESampler</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
    <span class="p">)</span>
<span class="n">re_study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="c1"># close logging file</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for model persistence</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">optuna</span>

<span class="c1"># serialize</span>
<span class="c1"># with open(&#39;models/re_study_1.pkl&#39;, &#39;wb&#39;) as f:</span>
<span class="c1">#     pickle.dump(re_study, f)</span>
<span class="c1"># with open(&#39;models/re_study_1_sampler.pkl&#39;, &#39;wb&#39;) as f:</span>
<span class="c1">#     pickle.dump(re_study.sampler, f)</span>
<span class="c1"># import serialized study</span>
<span class="n">re_study_sampler</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;models</span><span class="se">\\</span><span class="s1">re_study_1_sampler.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
<span class="n">re_study</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;models</span><span class="se">\\</span><span class="s1">re_study_1.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Comparing to previous optimization:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create dataframe</span>
<span class="n">re_study_results</span> <span class="o">=</span> <span class="n">create_df_from_study</span><span class="p">(</span><span class="n">re_study</span><span class="p">,</span> <span class="s1">&#39;models</span><span class="se">\\</span><span class="s1">xgb_opt_log_2023-01-26_18-27.log&#39;</span><span class="p">)</span>
<span class="c1"># plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">max_point_study_1</span> <span class="o">=</span> <span class="n">study_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">study_results</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">study_results</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">max_point_study_2</span> <span class="o">=</span> <span class="n">re_study_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">re_study_results</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">re_study_results</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">study_results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;initial&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">study_results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;xgb_iters&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;initial&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">re_study_results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#d62728&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;zooming&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">re_study_results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;xgb_iters&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#d62728&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;zooming&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">max_point_study_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">max_point_study_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">max_point_study_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">max_point_study_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trial Number&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score (AUC)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Optimization Score Growth&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trial Number&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;XGB Iterations&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Number of XGB Iterations&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/processed_81_0.png" src="../_images/processed_81_0.png" />
</div>
</div>
<p>Indeed we can observe slight performance improvement after the zooming process. The zooming process proven to be useful and at a correct path. Let’s take a look at tendencies of our algorithm optimization process of selecting the best hyperparams:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_parallel_coordinate</span><span class="p">(</span><span class="n">re_study</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/processed_83_0.png" src="../_images/processed_83_0.png" />
</div>
</div>
<p>Looks like <code class="docutils literal notranslate"><span class="pre">max_depth</span></code> can be a little higher. Further we can improve the model by fixing most of the least importances params and focuses more on <code class="docutils literal notranslate"><span class="pre">max_depth</span></code> and <code class="docutils literal notranslate"><span class="pre">learning_rate</span></code>.</p>
<p>For now, let’s conclude our hyperparameter optimization by these best parameters returned.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_params</span> <span class="o">=</span> <span class="n">re_study</span><span class="o">.</span><span class="n">best_params</span>
<span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;scale_pos_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;scale_post_weight&#39;</span><span class="p">]</span>
<span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;min_child_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;minimal_child_weight&#39;</span><span class="p">]</span>
<span class="k">del</span> <span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;scale_post_weight&#39;</span><span class="p">]</span>
<span class="k">del</span> <span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;minimal_child_weight&#39;</span><span class="p">]</span>
<span class="n">final_classifier</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">334</span><span class="p">,</span> <span class="o">**</span><span class="n">best_params</span><span class="p">)</span>
<span class="n">final_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_transfd</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">re_study_results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>92</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>number</th>
      <td>92</td>
    </tr>
    <tr>
      <th>value</th>
      <td>0.70</td>
    </tr>
    <tr>
      <th>datetime_start</th>
      <td>2023-01-27 02:22:43.314071</td>
    </tr>
    <tr>
      <th>datetime_complete</th>
      <td>2023-01-27 02:29:17.155771</td>
    </tr>
    <tr>
      <th>duration</th>
      <td>0 days 00:06:33.841700</td>
    </tr>
    <tr>
      <th>params_alpha</th>
      <td>6.33</td>
    </tr>
    <tr>
      <th>params_gamma</th>
      <td>4.68</td>
    </tr>
    <tr>
      <th>params_learning_rate</th>
      <td>0.03</td>
    </tr>
    <tr>
      <th>params_max_delta_step</th>
      <td>7.97</td>
    </tr>
    <tr>
      <th>params_max_depth</th>
      <td>6</td>
    </tr>
    <tr>
      <th>params_minimal_child_weight</th>
      <td>9.82</td>
    </tr>
    <tr>
      <th>params_scale_post_weight</th>
      <td>2.19</td>
    </tr>
    <tr>
      <th>params_subsample</th>
      <td>0.73</td>
    </tr>
    <tr>
      <th>state</th>
      <td>COMPLETE</td>
    </tr>
    <tr>
      <th>xgb_iters</th>
      <td>334</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><a id="7-model-implementation"> </a></p>
</section>
</section>
<section id="model-implementation-selecting-profitable-loan">
<h2>7. Model Implementation: Selecting Profitable Loan<a class="headerlink" href="#model-implementation-selecting-profitable-loan" title="Permalink to this headline">#</a></h2>
<p>I will demonstrate implementation of our prediction model to solve a simple problem: among available loan with specific profile, which loans that will be potential to generate profit and which is possibly defaulted so we can avoid loss.</p>
<p>This chapter focuses on developing <code class="docutils literal notranslate"><span class="pre">Loan</span> <span class="pre">Selector</span></code>, a simple algorithm to select possibly profitable loan. We will compare several loan selectors based on its particular selecting method and decide which selector has the best performance. Note that this is for demonstration only.</p>
<p><a id="7.1-preparation"> </a></p>
<section id="preparation">
<h3>7.1. Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline">#</a></h3>
<section id="strategy">
<h4><strong>Strategy</strong><a class="headerlink" href="#strategy" title="Permalink to this headline">#</a></h4>
<p>We will consider 4 methods of selecting profitable loan that can measure if our model can be advantageous and reliable to maximize investment return.</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">A</span></code>: We choose most of the available loan to be invested as possible. This serves as <code class="docutils literal notranslate"><span class="pre">non-informed</span></code> decision (generous investor).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">B</span></code>: We choose only possibly ‘good loan’. I determine ‘possibly good loan’ is the loan graded <code class="docutils literal notranslate"><span class="pre">A</span></code> or <code class="docutils literal notranslate"><span class="pre">B</span></code> (subjective!). This serves as <code class="docutils literal notranslate"><span class="pre">minimal-informed</span></code> decision.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">C</span></code>: Utilizing model’s probability of prediction. We select the potential loan which have value (see previous chapter): <span class="math notranslate nohighlight">\(P(loan=Good\;Loan)\times\;Return\;Ratio&gt;1\)</span> , some sort of calculating the <em>expectancy</em> of loan will profit.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">D</span></code>: Also utilizing model’s probability of prediction. But this time, we adjust the treshold of probability prediction as a filter for selecting loan.</p></li>
</ol>
<p>So, how to do the testing? We will try to simulate the real condition: opening the LendingClub website and inspect open loan that currently available. Therefore the simulations should be:</p>
<ol class="simple">
<li><p>We will do sampling by drawing observations multiple times (with replacement) from test set (including only finished loan). Further question: how many observations per sample?</p></li>
<li><p>Calculate the profit of each sample. Then we will calculate <code class="docutils literal notranslate"><span class="pre">mean</span></code> and <code class="docutils literal notranslate"><span class="pre">deviation</span></code> for each <code class="docutils literal notranslate"><span class="pre">selector</span></code>.</p></li>
</ol>
<p>Then, how many observations for each sample? Remember, from previous chapter, there exist <code class="docutils literal notranslate"><span class="pre">Issued</span></code> loan category at train set (unfortunately none available at test set). Assumming the records is collected by the end of the data record, let’s inspect number of <code class="docutils literal notranslate"><span class="pre">Issued</span></code> loan by the end periods!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">modules.data_preprocess</span> <span class="kn">import</span> <span class="n">LoanDataPreprocess</span>

<span class="n">train_set_observe</span> <span class="o">=</span> <span class="n">LoanDataPreprocess</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_set</span><span class="p">)</span>
<span class="n">train_set_observe</span>\
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;issue_d&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">loan_status</span> <span class="o">==</span> <span class="s1">&#39;Issued&#39;</span><span class="p">,</span> <span class="p">:]</span>\
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1M&#39;</span><span class="p">))</span>\
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">count_available_loan</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;loan_status&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">))</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count_available_loan</th>
    </tr>
    <tr>
      <th>issue_d</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-12-31</th>
      <td>8460</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s consider <code class="docutils literal notranslate"><span class="pre">300</span></code> of loans for our simulation (due to limitation of test set and to reduce solving difficulty).</p>
<blockquote>
<div><p>Note: performing statistical test may deemed appropriate in determining sample size for simulation</p>
</div></blockquote>
<p>Too make the case more interesting, let’s limit the value of total investment to just <code class="docutils literal notranslate"><span class="pre">$100,000</span></code> (consider this as an investment budget) and find which method make the most profits!</p>
</section>
<section id="preparing-the-data">
<h4><strong>Preparing the Data</strong><a class="headerlink" href="#preparing-the-data" title="Permalink to this headline">#</a></h4>
<p>Now we focus more on test dataset: Loan Dataset of 2016 - 2017. We will use our previous <code class="docutils literal notranslate"><span class="pre">dataset_preprocess</span></code> pipeline to subset the valid loan. However, we will include post-originated loan data: <code class="docutils literal notranslate"><span class="pre">funded_amnt_inv</span></code> and <code class="docutils literal notranslate"><span class="pre">total_pyment_inv</span></code>.</p>
<p>We will asert if the testing dataset (for profit) is match with <code class="docutils literal notranslate"><span class="pre">X_test</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">testing_dataset_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocess&#39;</span><span class="p">,</span> <span class="n">LoanDataPreprocess</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">&#39;extract_label_predictor&#39;</span><span class="p">,</span> <span class="n">LoanDataLabelPredictor</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;earliest_cr_line&#39;</span><span class="p">,</span> <span class="s1">&#39;pymnt_plan&#39;</span><span class="p">,</span> <span class="s1">&#39;policy_code&#39;</span><span class="p">],</span> 
                                                       <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_rec_prncp&#39;</span><span class="p">,</span> <span class="s1">&#39;funded_amnt_inv&#39;</span><span class="p">,</span> <span class="s1">&#39;total_pymnt_inv&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;total_rec_int&#39;</span><span class="p">,</span> <span class="s1">&#39;total_rec_late_fee&#39;</span><span class="p">,</span> <span class="s1">&#39;recoveries&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;collection_recovery_fee&#39;</span><span class="p">,</span> <span class="s1">&#39;out_prncp_inv&#39;</span><span class="p">,</span> <span class="s1">&#39;funded_amnt&#39;</span><span class="p">,</span> 
                                                                <span class="s1">&#39;total_pymnt&#39;</span><span class="p">])),</span>
    <span class="p">(</span><span class="s1">&#39;missing_handler&#39;</span><span class="p">,</span> <span class="n">LoanDataMissingHandler</span><span class="p">()),</span>
    <span class="p">])</span>

<span class="n">testing_df</span><span class="p">,</span> <span class="n">testing_label</span> <span class="o">=</span> <span class="n">testing_dataset_pipeline</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">test_set</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">testing_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>No <code class="docutils literal notranslate"><span class="pre">AssertionError</span></code> raised. Furthermore, we can assure that each of the observations match with testing dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">loan_amnt</span> <span class="o">==</span> <span class="n">testing_df</span><span class="o">.</span><span class="n">loan_amnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>All of the records match! For simplicity, we just merge the probability prediction of the model to the <code class="docutils literal notranslate"><span class="pre">testing_df</span></code>. So our testing dataframe should contain:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">loan_amnt</span></code>, the amount of loan that has been funded</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">total_pymnt</span></code>, the amount of payment that obtained, including principal payment, interest payment, late fee, and recoveries (for defaulted loan)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">actual_return</span></code>, is calculated as <code class="docutils literal notranslate"><span class="pre">total_pymnt</span></code> - <code class="docutils literal notranslate"><span class="pre">loan_amnt</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">probability_bad_loan</span></code>, is the result of our classification model.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">testing_df</span> <span class="o">=</span> <span class="n">testing_df</span>\
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">proba_bad_loan</span><span class="o">=</span><span class="n">final_classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_transfd</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">potential_return</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">loan_amnt</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">int_rate</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">actual_return</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">total_pymnt</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">loan_amnt</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;loan_amnt&#39;</span><span class="p">,</span> <span class="s1">&#39;int_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">,</span> <span class="s1">&#39;potential_return&#39;</span><span class="p">,</span> <span class="s1">&#39;actual_return&#39;</span><span class="p">,</span> <span class="s1">&#39;proba_bad_loan&#39;</span><span class="p">]]</span>

<span class="n">testing_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>int_rate</th>
      <th>grade</th>
      <th>potential_return</th>
      <th>actual_return</th>
      <th>proba_bad_loan</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>11575.00</td>
      <td>7.35</td>
      <td>A</td>
      <td>850.76</td>
      <td>132.82</td>
      <td>0.19</td>
    </tr>
    <tr>
      <th>1</th>
      <td>7200.00</td>
      <td>24.85</td>
      <td>E</td>
      <td>1789.20</td>
      <td>6.46</td>
      <td>0.73</td>
    </tr>
    <tr>
      <th>2</th>
      <td>7500.00</td>
      <td>7.35</td>
      <td>A</td>
      <td>551.25</td>
      <td>142.29</td>
      <td>0.17</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10000.00</td>
      <td>16.02</td>
      <td>C</td>
      <td>1602.00</td>
      <td>26.70</td>
      <td>0.44</td>
    </tr>
    <tr>
      <th>4</th>
      <td>14000.00</td>
      <td>16.02</td>
      <td>C</td>
      <td>2242.80</td>
      <td>375.14</td>
      <td>0.42</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Finally, <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">D</span></code> will be involved in optimization algorithm. So we want to split that set to have isolated <code class="docutils literal notranslate"><span class="pre">validation_set</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">testing_df_test</span><span class="p">,</span> <span class="n">testing_df_valid</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">testing_df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">5555</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id="7.2-develop-selectors"> </a></p>
</section>
</section>
<section id="develop-the-selectors-and-optimization-process">
<h3>7.2. Develop the <code class="docutils literal notranslate"><span class="pre">Selectors</span></code> and Optimization Process<a class="headerlink" href="#develop-the-selectors-and-optimization-process" title="Permalink to this headline">#</a></h3>
<section id="knapsack-problem-and-solving-using-pyomo">
<h4><strong>Knapsack Problem and Solving using <em>Pyomo</em></strong><a class="headerlink" href="#knapsack-problem-and-solving-using-pyomo" title="Permalink to this headline">#</a></h4>
<p>Selecting the most profitable loan in a specific budget limit is an example of <em>knapsack</em> problem: we select loans with specific price and value to include in the combination so that the total value is as large as possible while keeping the total price under the constraint.</p>
<p>To correlate this concept with our problem: Given a set of <span class="math notranslate nohighlight">\(n\)</span> available loan (in our case, <span class="math notranslate nohighlight">\(n=500\)</span>), each particular loan indices (<span class="math notranslate nohighlight">\(i\)</span>) has a price <span class="math notranslate nohighlight">\(w_i\)</span> and a value <span class="math notranslate nohighlight">\(v_i\)</span>: our action is to buy that particular loan (<span class="math notranslate nohighlight">\(w_i\times\;1\)</span>) or ignore the loan (<span class="math notranslate nohighlight">\(w_i\times\;0\)</span>) so that we can</p>
<div class="math notranslate nohighlight">
\[maximize:\;\sum_{
    \begin{subarray}{l}1\leq\;i\leq\;n\end{subarray}
}v_ix_i\]</div>
<div class="math notranslate nohighlight">
\[x_i\in\;(0,\;1)\]</div>
<p>While keeping the total price <span class="math notranslate nohighlight">\(W\)</span> under the budget constraint. So our maximization problem</p>
<div class="math notranslate nohighlight">
\[subject\;to:\;\sum_{
    \begin{subarray}{l}1\leq\;i\leq\;n\end{subarray}
}w_ix_i\leq\;W\]</div>
<p>The value <span class="math notranslate nohighlight">\(v_i\)</span> is specific for each of our <code class="docutils literal notranslate"><span class="pre">Selector</span></code>, explained shortly.</p>
<p>Code below provides a function that solve our knapsack problem to return the loan indices <span class="math notranslate nohighlight">\(i\)</span>: <span class="math notranslate nohighlight">\(f(v_i,\;w_i,\;W)\rightarrow\;\set{i}\;which\;maximize\;(\sum_{
    \begin{subarray}{l}1\leq\;i\leq\;n\end{subarray}
}v_ix_i)\)</span>.</p>
<p>In linear programming terms, knapsack problem is categorized as <em>Mixed Integer Linear Programming</em> (MILP). We shall choose appropriate solver that can tackle MILP, so I choose <a class="reference external" href="https://scipopt.org">SCIP</a>. We will use <code class="docutils literal notranslate"><span class="pre">pyomo</span></code> API to instantiate the solver:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyomo.environ</span> <span class="k">as</span> <span class="nn">pyo</span>

<span class="k">def</span> <span class="nf">get_loan_choice</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">constraint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value: ArrayLike with shape (n, )</span>
<span class="sd">    weight: ArrayLike with shape (n, )</span>
<span class="sd">    constraint: Scalar</span>
<span class="sd">     &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">obj_rule</span><span class="p">(</span><span class="n">model_</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model_</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">model_</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model_</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">const_rule</span><span class="p">(</span><span class="n">model_</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">model_</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">model_</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model_</span><span class="o">.</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">i_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">value_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>   <span class="c1"># need to create dictionary</span>
    <span class="n">weight_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">weight</span><span class="p">))</span> <span class="c1"># this is due to pyomo structure is dict-like</span>
    <span class="c1"># pyo model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">RangeSet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># indexing object. Refer to our formula, we only need `i` for indexing</span>
    <span class="n">model</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">value_map</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> <span class="c1">#.Param object is fixed value</span>
    <span class="n">model</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">weight_map</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeIntegers</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">#.Var object is value to be obtained by optimizing</span>
    <span class="n">model</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">constraint</span><span class="p">)</span> <span class="c1"># Scalar Constraint</span>
    <span class="n">model</span><span class="o">.</span><span class="n">OBJ</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">obj_rule</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span> <span class="c1"># we only need 1 coonstraint</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONST</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">const_rule</span><span class="p">)</span> <span class="c1"># we need only 1 constraint</span>
    <span class="c1"># start the solver</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;scip&#39;</span><span class="p">,</span> <span class="n">solver_io</span><span class="o">=</span><span class="s1">&#39;nl&#39;</span><span class="p">)</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">loan_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_</span><span class="p">()</span> <span class="k">for</span> <span class="n">v_</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span> <span class="c1"># after optimization is completed, just access the model.x values.</span>
    <span class="n">selected_loan_idx</span> <span class="o">=</span> <span class="n">i_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">loan_mask</span><span class="p">)]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="c1"># return the index of loan to buy</span>
    <span class="k">return</span> <span class="n">selected_loan_idx</span>
</pre></div>
</div>
</div>
</div>
<p>Notice carefully about each of the model attribute. We specified indexing <code class="docutils literal notranslate"><span class="pre">i</span></code> (<code class="docutils literal notranslate"><span class="pre">model.i</span></code>) for variables  so that those attributes created as <code class="docutils literal notranslate"><span class="pre">pyo.IndexedParam</span></code> (by passing <code class="docutils literal notranslate"><span class="pre">model.i</span></code> at the first arguments to reflect <span class="math notranslate nohighlight">\(v_i\)</span>, <span class="math notranslate nohighlight">\(w_i\)</span>, <span class="math notranslate nohighlight">\(x_i\)</span>). However, <code class="docutils literal notranslate"><span class="pre">model.i</span></code> is not passed to <code class="docutils literal notranslate"><span class="pre">model.W</span></code> since it must be a <code class="docutils literal notranslate"><span class="pre">Scalar</span></code> variable.</p>
</section>
<section id="selector-a">
<h4><strong>Selector A</strong><a class="headerlink" href="#selector-a" title="Permalink to this headline">#</a></h4>
<p>For <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">A</span></code>, we just need to find combination of loans (for each sample) which sum of the <code class="docutils literal notranslate"><span class="pre">loan_amnt</span></code> (<span class="math notranslate nohighlight">\(W\)</span>) is the nearest to our budget constraint (<code class="docutils literal notranslate"><span class="pre">$100,000</span></code>), with <em>value</em> (<span class="math notranslate nohighlight">\(v_i\)</span>) of the loan is simply the potential loan profit (tagged as <code class="docutils literal notranslate"><span class="pre">potential_return</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">SelectorA</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">return_total_funding</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># input</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">potential_return</span><span class="o">.</span><span class="n">values</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loan_amnt</span><span class="o">.</span><span class="n">values</span>
    <span class="n">actual_return</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">actual_return</span><span class="o">.</span><span class="n">values</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">budget</span>
    <span class="c1"># output</span>
    <span class="n">loan_idx</span> <span class="o">=</span> <span class="n">get_loan_choice</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
    <span class="c1"># summary</span>
    <span class="n">net_return</span> <span class="o">=</span> <span class="n">actual_return</span><span class="p">[</span><span class="n">loan_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_funding</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="n">loan_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">return_total_funding</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">net_return</span><span class="p">,</span> <span class="n">total_funding</span>
    <span class="k">return</span> <span class="n">net_return</span>

<span class="n">sample_df</span> <span class="o">=</span> <span class="n">testing_df_test</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
<span class="n">net_return</span><span class="p">,</span> <span class="n">total_funding</span> <span class="o">=</span> <span class="n">SelectorA</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Selector A. Total funding = $</span><span class="si">{</span><span class="n">total_funding</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">, return = $</span><span class="si">{</span><span class="n">net_return</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Selector A. Total funding = $99,850, return = $-33,490
</pre></div>
</div>
</div>
</div>
</section>
<section id="selector-b">
<h4><strong>Selector B</strong><a class="headerlink" href="#selector-b" title="Permalink to this headline">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">B</span></code> is rather similar to <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">A</span></code>, but before we pick the combinations, we must filter the dataframe to only include <code class="docutils literal notranslate"><span class="pre">Grade</span> <span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">Grade</span> <span class="pre">B</span></code> loan.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">SelectorB</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">return_total_funding</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">subset_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">grade</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">])]</span>
    <span class="c1"># input</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">subset_df</span><span class="o">.</span><span class="n">potential_return</span><span class="o">.</span><span class="n">values</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">subset_df</span><span class="o">.</span><span class="n">loan_amnt</span><span class="o">.</span><span class="n">values</span>
    <span class="n">actual_return</span> <span class="o">=</span> <span class="n">subset_df</span><span class="o">.</span><span class="n">actual_return</span><span class="o">.</span><span class="n">values</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">budget</span>
    <span class="c1"># output</span>
    <span class="n">loan_idx</span> <span class="o">=</span> <span class="n">get_loan_choice</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
    <span class="c1"># summary</span>
    <span class="n">net_return</span> <span class="o">=</span> <span class="n">actual_return</span><span class="p">[</span><span class="n">loan_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_funding</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="n">loan_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">return_total_funding</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">net_return</span><span class="p">,</span> <span class="n">total_funding</span>
    <span class="k">return</span> <span class="n">net_return</span>

<span class="n">sample_df</span> <span class="o">=</span> <span class="n">testing_df_test</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<span class="n">net_return</span><span class="p">,</span> <span class="n">total_funding</span> <span class="o">=</span> <span class="n">SelectorB</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Selector B. Total funding = $</span><span class="si">{</span><span class="n">total_funding</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">, return = $</span><span class="si">{</span><span class="n">net_return</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Selector B. Total funding = $100,000, return = $-1,252
</pre></div>
</div>
</div>
</div>
</section>
<section id="selector-c">
<h4><strong>Selector C</strong><a class="headerlink" href="#selector-c" title="Permalink to this headline">#</a></h4>
<p>Recall from previous section, <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">C</span></code> calculate the ratio of valuable loan:</p>
<div class="math notranslate nohighlight">
\[P(loan=Good\;Loan)\times\;Return\;Ratio&gt;1\]</div>
<p>Some other may include <em>risk-free rate</em> in the right side of the equation, which is the rate of return that an investor can expect to earn on an invesment that carries no risk of default. Because, why bother investing in a loan that have lower (expected) return than investment with exact return.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">SelectorC</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">return_total_funding</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># input</span>
    <span class="n">subset_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">value_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">proba_bad_loan</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">int_rate</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">subset_df</span> <span class="o">=</span> <span class="n">subset_df</span><span class="p">[</span><span class="n">subset_df</span><span class="o">.</span><span class="n">value_ratio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_total_funding</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">subset_df</span><span class="o">.</span><span class="n">value_ratio</span><span class="o">.</span><span class="n">values</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">subset_df</span><span class="o">.</span><span class="n">loan_amnt</span><span class="o">.</span><span class="n">values</span>
    <span class="n">actual_return</span> <span class="o">=</span> <span class="n">subset_df</span><span class="o">.</span><span class="n">actual_return</span><span class="o">.</span><span class="n">values</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">budget</span>
    <span class="c1"># output</span>
    <span class="n">loan_idx</span> <span class="o">=</span> <span class="n">get_loan_choice</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
    <span class="c1"># summary</span>
    <span class="n">net_return</span> <span class="o">=</span> <span class="n">actual_return</span><span class="p">[</span><span class="n">loan_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_funding</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="n">loan_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">return_total_funding</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">net_return</span><span class="p">,</span> <span class="n">total_funding</span>
    <span class="k">return</span> <span class="n">net_return</span>

<span class="n">sample_df</span> <span class="o">=</span> <span class="n">testing_df_test</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<span class="n">net_return</span><span class="p">,</span> <span class="n">total_funding</span> <span class="o">=</span> <span class="n">SelectorC</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Selector C. Total funding = $</span><span class="si">{</span><span class="n">total_funding</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">, return = $</span><span class="si">{</span><span class="n">net_return</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Selector C. Total funding = $0, return = $0
</pre></div>
</div>
</div>
</div>
</section>
<section id="selector-d">
<h4><strong>Selector D</strong><a class="headerlink" href="#selector-d" title="Permalink to this headline">#</a></h4>
<p>For our final <code class="docutils literal notranslate"><span class="pre">Selector</span></code>, we adjust the treshold of probability to filter which loan we will choose. We will find the best value of threshold for our condition, again by using <code class="docutils literal notranslate"><span class="pre">optuna</span></code>. Later, recall the <em>TPR</em> and <em>FPR</em>, we will analyze our choice of treshold.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">SelectorD</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">return_total_funding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">treshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">value_choice</span><span class="o">=</span><span class="s1">&#39;potential_return&#39;</span><span class="p">):</span>
    <span class="c1"># input</span>
    <span class="n">subset_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">proba_bad_loan</span> <span class="o">&lt;</span> <span class="n">treshold</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_total_funding</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">value_choice</span> <span class="o">==</span> <span class="s1">&#39;proba_bad_loan&#39;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">subset_df</span><span class="o">.</span><span class="n">proba_bad_loan</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="k">elif</span> <span class="n">value_choice</span> <span class="o">==</span> <span class="s1">&#39;potential_return&#39;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">subset_df</span><span class="o">.</span><span class="n">potential_return</span><span class="o">.</span><span class="n">values</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">subset_df</span><span class="o">.</span><span class="n">loan_amnt</span><span class="o">.</span><span class="n">values</span>
    <span class="n">actual_return</span> <span class="o">=</span> <span class="n">subset_df</span><span class="o">.</span><span class="n">actual_return</span><span class="o">.</span><span class="n">values</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">budget</span>
    <span class="c1"># output</span>
    <span class="n">loan_idx</span> <span class="o">=</span> <span class="n">get_loan_choice</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
    <span class="c1"># summary</span>
    <span class="n">net_return</span> <span class="o">=</span> <span class="n">actual_return</span><span class="p">[</span><span class="n">loan_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_funding</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="n">loan_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">return_total_funding</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">net_return</span><span class="p">,</span> <span class="n">total_funding</span>
    <span class="k">return</span> <span class="n">net_return</span>

<span class="n">sample_df</span> <span class="o">=</span> <span class="n">testing_df_test</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<span class="n">net_return</span><span class="p">,</span> <span class="n">total_funding</span> <span class="o">=</span> <span class="n">SelectorD</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Selector D. Total funding = $</span><span class="si">{</span><span class="n">total_funding</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">, return = $</span><span class="si">{</span><span class="n">net_return</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Selector D. Total funding = $99,550, return = $-23,036
</pre></div>
</div>
</div>
</div>
<p>Now we have two parameters to adjust: <code class="docutils literal notranslate"><span class="pre">treshold</span></code> and <code class="docutils literal notranslate"><span class="pre">value_choice</span></code>. Let’s try to find the best params!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statistics</span> <span class="k">as</span> <span class="nn">st</span>

<span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
    <span class="n">budget</span> <span class="o">=</span> <span class="mi">100000</span>
    <span class="n">treshold</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;treshold&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">value_choice</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s1">&#39;value_choice&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;proba_bad_loan&#39;</span><span class="p">,</span> <span class="s1">&#39;potential_return&#39;</span><span class="p">])</span>
    <span class="n">net_return</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">sample_df</span> <span class="o">=</span> <span class="n">testing_df_valid</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">net_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">SelectorD</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">treshold</span><span class="o">=</span><span class="n">treshold</span><span class="p">,</span> <span class="n">value_choice</span><span class="o">=</span><span class="n">value_choice</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="n">mean_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">net_return</span><span class="p">)</span>
    <span class="n">std_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">net_return</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mean_return</span><span class="p">,</span> <span class="n">std_return</span>

<span class="n">optimize_selector_d</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span>
    <span class="n">directions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;maximize&#39;</span><span class="p">,</span> <span class="s1">&#39;minimize&#39;</span><span class="p">],</span> <span class="n">sampler</span><span class="o">=</span><span class="n">optuna</span><span class="o">.</span><span class="n">samplers</span><span class="o">.</span><span class="n">TPESampler</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
    <span class="p">)</span>
<span class="n">optimize_selector_d</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="c1">#output</span>
<span class="n">best_net_return_trial</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">optimize_selector_d</span><span class="o">.</span><span class="n">best_trials</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">best_std_return_trial</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">optimize_selector_d</span><span class="o">.</span><span class="n">best_trials</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s1">&#39;Trial with highest net return, Selector D:</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">l = </span><span class="si">{</span><span class="n">best_net_return_trial</span><span class="o">.</span><span class="n">params</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">mean return = $</span><span class="si">{</span><span class="n">best_net_return_trial</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">std return = $</span><span class="si">{</span><span class="n">best_net_return_trial</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s1">&#39;Trial with lowest std return, Selector D:</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">params = </span><span class="si">{</span><span class="n">best_std_return_trial</span><span class="o">.</span><span class="n">params</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">mean return = $</span><span class="si">{</span><span class="n">best_std_return_trial</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">std return = $</span><span class="si">{</span><span class="n">best_std_return_trial</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trial with highest net return, Selector D:
	l = {&#39;treshold&#39;: 0.1172706474398198, &#39;value_choice&#39;: &#39;potential_return&#39;}
	mean return = $966
	std return = $3,941

Trial with lowest std return, Selector D:
	params = {&#39;treshold&#39;: 0.015723193813149072, &#39;value_choice&#39;: &#39;proba_bad_loan&#39;}
	mean return = $0
	std return = $0
</pre></div>
</div>
</div>
</div>
<p>Our best possible treshold is around <code class="docutils literal notranslate"><span class="pre">0.12</span></code>. The expected return looks promising but it also has large uncertainties. Let’s inspect the ROC curve for our model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">RocCurveDisplay</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">LearningCurveDisplay</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">treshold</span> <span class="o">=</span> <span class="mf">0.11</span>
<span class="n">y_score</span> <span class="o">=</span> <span class="n">final_classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_transfd</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">y_pred_at_tresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_score</span> <span class="o">&gt;=</span> <span class="n">treshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">conf_mat</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_at_tresh</span><span class="p">)</span>
<span class="n">tpr_at_tresh</span> <span class="o">=</span> <span class="n">conf_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">conf_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">conf_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">fpr_at_tresh</span> <span class="o">=</span> <span class="n">conf_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">conf_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">conf_mat</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="c1"># plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">RocCurveDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">final_classifier</span><span class="p">,</span> <span class="n">X_test_transfd</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">fpr_at_tresh</span><span class="p">,</span> <span class="n">tpr_at_tresh</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">fpr_at_tresh</span><span class="p">],</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="p">[</span><span class="n">tpr_at_tresh</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">tpr_at_tresh</span><span class="p">],</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="p">[</span><span class="n">fpr_at_tresh</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="n">fpr_at_tresh</span> <span class="o">-</span> <span class="mf">0.41</span><span class="p">,</span> 
    <span class="n">tpr_at_tresh</span> <span class="o">+</span> <span class="mf">0.015</span><span class="p">,</span> 
    <span class="n">s</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;(Treshold = </span><span class="si">{</span><span class="n">treshold</span><span class="si">}</span><span class="s1">. TPR: </span><span class="si">{</span><span class="n">tpr_at_tresh</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, FPR: </span><span class="si">{</span><span class="n">fpr_at_tresh</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ROC Curve&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/processed_122_0.png" src="../_images/processed_122_0.png" />
</div>
</div>
<p>Using <span class="math notranslate nohighlight">\(0.12\)</span> threshold, we got <span class="math notranslate nohighlight">\(0.998\)</span> <em>True Positive Rate</em> at <span class="math notranslate nohighlight">\(0.976\)</span> <em>False Positive Rate</em>. We falsely reject almost <span class="math notranslate nohighlight">\(97\%\)</span> of <code class="docutils literal notranslate"><span class="pre">Good</span> <span class="pre">Loan</span></code>. This produce a very strict selection of loan, obviously because wrongly deciding to buy <code class="docutils literal notranslate"><span class="pre">Bad</span> <span class="pre">Loan</span></code> may lead to a more devastating outcome than rejecting <code class="docutils literal notranslate"><span class="pre">Good</span> <span class="pre">Loan</span></code>. By looking at this result, it is essential to report our model performance alongside its trade-off counterparts!</p>
<p>Then how can we get a lower <em>FPR</em>? The dataset itself may have its own nature of providing such challenging problem. Real-world dataset can be very complex and non-linear, making it difficult to find a decision boundary that accurately separates the different classes. However, it is most often possible to find effective solutions although may requires significant computational resource, time, and domain expertise. In simple words, create a better model!</p>
<p>Next, let’s compare each of our <code class="docutils literal notranslate"><span class="pre">Selector</span></code>!</p>
<p><a id="7.3-comparations"> </a></p>
</section>
</section>
<section id="comparation-of-selector-performance">
<h3>7.3. Comparation of <code class="docutils literal notranslate"><span class="pre">Selector</span></code> Performance<a class="headerlink" href="#comparation-of-selector-performance" title="Permalink to this headline">#</a></h3>
<p>This below lengthy code shows the process contained at each of the iteration:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">return_A</span><span class="p">,</span> <span class="n">investment_A</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="n">return_B</span><span class="p">,</span> <span class="n">investment_B</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="n">return_C</span><span class="p">,</span> <span class="n">investment_C</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="n">return_D</span><span class="p">,</span> <span class="n">investment_D</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="n">iter_num</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">budget</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="c1"># setting up iteration</span>
<span class="n">n_iter</span> <span class="o">=</span> <span class="mi">300</span>
<span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter</span><span class="p">):</span>
    <span class="n">iter_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sample_df</span> <span class="o">=</span> <span class="n">testing_df_test</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
    <span class="c1"># Selector A</span>
    <span class="n">r_A</span><span class="p">,</span> <span class="n">i_A</span> <span class="o">=</span> <span class="n">SelectorA</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">return_total_funding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">return_A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_A</span><span class="p">)</span>
    <span class="n">investment_A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_A</span><span class="p">)</span>
    <span class="c1"># Selector B</span>
    <span class="n">r_B</span><span class="p">,</span> <span class="n">i_B</span> <span class="o">=</span> <span class="n">SelectorB</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">return_total_funding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">return_B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_B</span><span class="p">)</span>
    <span class="n">investment_B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_B</span><span class="p">)</span>
    <span class="c1"># Selector C</span>
    <span class="n">r_C</span><span class="p">,</span> <span class="n">i_C</span> <span class="o">=</span> <span class="n">SelectorC</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">return_total_funding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">return_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_C</span><span class="p">)</span>
    <span class="n">investment_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_C</span><span class="p">)</span>
    <span class="c1"># Selector D</span>
    <span class="n">r_D</span><span class="p">,</span> <span class="n">i_D</span> <span class="o">=</span> <span class="n">SelectorD</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">,</span> <span class="n">return_total_funding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">treshold</span><span class="o">=</span> <span class="mf">0.11</span><span class="p">,</span> <span class="n">value_choice</span><span class="o">=</span><span class="s1">&#39;potential_return&#39;</span><span class="p">)</span>
    <span class="n">return_D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_D</span><span class="p">)</span>
    <span class="n">investment_D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_D</span><span class="p">)</span>
<span class="c1"># create dataframe</span>
<span class="n">return_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;iter_num&#39;</span><span class="p">:</span> <span class="n">iter_num</span><span class="p">,</span>
    <span class="s1">&#39;Selector A: non-informed decision&#39;</span><span class="p">:</span> <span class="n">return_A</span><span class="p">,</span>
    <span class="s1">&#39;Selector B: minimal-informed decision&#39;</span><span class="p">:</span> <span class="n">return_B</span><span class="p">,</span>
    <span class="s1">&#39;Selector C: model-informed, proba-based&#39;</span><span class="p">:</span> <span class="n">return_C</span><span class="p">,</span>
    <span class="s1">&#39;Selector D: model-informed, filtered&#39;</span><span class="p">:</span> <span class="n">return_D</span>
    <span class="p">})</span>
<span class="n">return_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
    <span class="n">return_df</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;iter_num&#39;</span><span class="p">],</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;actual_return&#39;</span>
    <span class="p">)</span>
<span class="n">investment_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;iter_num&#39;</span><span class="p">:</span> <span class="n">iter_num</span><span class="p">,</span>
    <span class="s1">&#39;Selector A: non-informed decision&#39;</span><span class="p">:</span> <span class="n">investment_A</span><span class="p">,</span>
    <span class="s1">&#39;Selector B: minimal-informed decision&#39;</span><span class="p">:</span> <span class="n">investment_B</span><span class="p">,</span>
    <span class="s1">&#39;Selector C: model-informed, proba-based&#39;</span><span class="p">:</span> <span class="n">investment_C</span><span class="p">,</span>
    <span class="s1">&#39;Selector D: model-informed, filtered&#39;</span><span class="p">:</span> <span class="n">investment_D</span>
    <span class="p">})</span>
<span class="n">investment_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
    <span class="n">investment_df</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;iter_num&#39;</span><span class="p">],</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;total_investment&#39;</span> 
    <span class="p">)</span>
<span class="n">compare_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">return_df</span><span class="p">,</span> <span class="n">investment_df</span>
    <span class="p">)</span>
<span class="n">compare_df</span> <span class="o">=</span> <span class="n">compare_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">roi</span><span class="o">=</span><span class="p">(</span><span class="n">compare_df</span><span class="o">.</span><span class="n">actual_return</span> <span class="o">/</span> <span class="n">compare_df</span><span class="o">.</span><span class="n">total_investment</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;selector&#39;</span><span class="p">})</span>
<span class="n">compare_agg_df</span> <span class="o">=</span> <span class="n">compare_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;selector&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span>
<span class="n">selectors</span> <span class="o">=</span> <span class="n">compare_df</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">avg_return</span> <span class="o">=</span> <span class="n">compare_agg_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">std_return</span> <span class="o">=</span> <span class="n">compare_agg_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">avg_investment</span> <span class="o">=</span> <span class="n">compare_agg_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">std_investment</span> <span class="o">=</span> <span class="n">compare_agg_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">avg_roi</span> <span class="o">=</span> <span class="n">compare_agg_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span>
<span class="n">std_roi</span> <span class="o">=</span> <span class="n">compare_agg_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span>
<span class="n">return_leg</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">selector</span><span class="si">}</span><span class="s1">, </span><span class="se">\n</span><span class="s1">avg = $</span><span class="si">{</span><span class="n">avg</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">, std = $</span><span class="si">{</span><span class="n">std</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">selector</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">std</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">selectors</span><span class="p">,</span> <span class="n">avg_return</span><span class="p">,</span> <span class="n">std_return</span><span class="p">)</span>
    <span class="p">]</span>
<span class="n">investment_leg</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">selector</span><span class="si">}</span><span class="s1">, </span><span class="se">\n</span><span class="s1">avg = $</span><span class="si">{</span><span class="n">avg</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">, std = $</span><span class="si">{</span><span class="n">std</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">selector</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">std</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">selectors</span><span class="p">,</span> <span class="n">avg_investment</span><span class="p">,</span> <span class="n">std_investment</span><span class="p">)</span>
    <span class="p">]</span>
<span class="n">roi_leg</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">selector</span><span class="si">}</span><span class="s1">, </span><span class="se">\n</span><span class="s1">avg = </span><span class="si">{</span><span class="n">avg</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, std = </span><span class="si">{</span><span class="n">std</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">selector</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">std</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">selectors</span><span class="p">,</span> <span class="n">avg_roi</span><span class="p">,</span> <span class="n">std_roi</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look at the distribution of return and amount of invested fund!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">compare_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;actual_return&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;selector&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">compare_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;total_investment&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;selector&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">return_leg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">5e-5</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sampling Distribution of Return&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">investment_leg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sampling Distribution of Total Investment&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2e-4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/processed_128_0.png" src="../_images/processed_128_0.png" />
</div>
</div>
<p>As we can see the model-informed loan selector, on average, has a better return than the selector without model involvement. Moreover, we can inspect that <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">C</span></code> may provide lower investment risk than <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">D</span></code> by simply looking at the standard deviation value (which means the deviation, on average, from the likelihood of the return), but the return is also lower (as some said, low risk low return). Inspect the distribution that has a higher frequency of having negative return.</p>
<p>Each of the models has its unique style for investing. For <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">B</span></code>, the investment is always maximized since there is always their-kind-of loan available to choose. <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">C</span></code> is rather playing-it-save with the investment. <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">D</span></code> is always looking for opportunity, if any, as we can see the investment amount is almost uniformly distributed.</p>
<p>Notice that, for <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">D</span></code>, there is <em>second mode</em> that appears in the distribution, which suggest unusual observations may exist.</p>
<p>Both of those variable commonly considered in a metric called <em>Return of Investment (ROI)</em>, which is simply the yield return. Again, let’s compare the ROI for those selectors!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">compare_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;roi&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;selector&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">return_leg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sampling Distribution of Return&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">roi_leg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sampling Distribution of ROI&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/processed_130_0.png" src="../_images/processed_130_0.png" />
</div>
</div>
<p>Selector that utilize prediction model tends to have positive <em>ROI</em> rather than other models. Moreover, <code class="docutils literal notranslate"><span class="pre">Selector</span> <span class="pre">D</span></code> tends to give consistent results among others.</p>
<p>So, do you agree if the model may help us delivering informed decision? Or is there any better way to select the loan?</p>
<p><a id="8-final-words"> </a></p>
</section>
</section>
<section id="final-words">
<h2>8. Final Words<a class="headerlink" href="#final-words" title="Permalink to this headline">#</a></h2>
<p>I already demonstrate simple process of developing prediction model and implementation to solve real problem. We looked at how to prepare the dataset, selecting the potential model, doing some feature engineering and adjusting the model parameters to get optimized model.</p>
<p>The model selection above is rather a simple approach to select the model. Classification algorithms should have a large improvement after some sort of tweaks is performed. For example, many classification algorithm works better with smaller dimension of training instances so we can do some sort of feature subsetting (for example, <em>RFE</em> and <em>Sequential Feature Selection</em>) and step back to the iteration to inspect each of the algorithm’s potential. <em>KNN Classifier</em> is punished harder in higher dimensional spaces, due to its difficulties in finding neighbours. It is known to perform better with some of dimensionality reduction method, for example with using <em>Neighborhood Component Analysis</em>: a supervised dimensionality reduction method. Considering those, it is also possible to develop <em>AutoML</em> for model selection, if the resource is available.</p>
<p>After all, we should be able to show that a machine learning model can be useful to tackle real world problems, which I already tried to do in this analysis. Otherwise, there is no purpose of doing hefty work of developing a model.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./build"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Nafis Barizki<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>